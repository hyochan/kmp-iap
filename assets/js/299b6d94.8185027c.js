"use strict";(self.webpackChunkkmp_iap_docs=self.webpackChunkkmp_iap_docs||[]).push([[488],{1437:(e,n,i)=>{i.d(n,{A:()=>t});i(6540);var s=i(7856),r=i(4848);function t({children:e,href:n,className:i,style:t}){return(0,r.jsx)("a",{href:n||s.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(s.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track link click:",e)}},className:i,style:t,children:e})}},1857:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var s=i(4848),r=i(8453),t=i(5159),c=i(1437);const o={sidebar_position:2,title:"Subscription Flow"},a="Subscription Flow",l={id:"examples/subscription-flow",title:"Subscription Flow",description:"Key Concepts",source:"@site/versioned_docs/version-1.0.0/examples/subscription-flow.md",sourceDirName:"examples",slug:"/examples/subscription-flow",permalink:"/kmp-iap/docs/1.0.0/examples/subscription-flow",draft:!1,unlisted:!1,editUrl:"https://github.com/hyochan/kmp-iap/tree/main/docs/versioned_docs/version-1.0.0/examples/subscription-flow.md",tags:[],version:"1.0.0",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Subscription Flow"},sidebar:"docsSidebar",previous:{title:"Purchase Flow",permalink:"/kmp-iap/docs/1.0.0/examples/purchase-flow"},next:{title:"Complete Implementation",permalink:"/kmp-iap/docs/1.0.0/examples/complete-implementation"}},d={},p=[{value:"Key Concepts",id:"key-concepts",level:2},{value:"Fetch Subscriptions",id:"fetch-subscriptions",level:2},{value:"Check Active Subscriptions",id:"check-active-subscriptions",level:2},{value:"Request Subscription",id:"request-subscription",level:2},{value:"Finish Transaction",id:"finish-transaction",level:2},{value:"Platform-Specific Info",id:"platform-specific-info",level:2},{value:"Android Subscription Management",id:"android-subscription-management",level:2},{value:"IAPKit Server Verification",id:"iapkit-server-verification",level:2},{value:"Setup",id:"setup",level:3},{value:"Subscription Verification",id:"subscription-verification",level:3},{value:"Verification Response",id:"verification-response",level:3},{value:"Periodic Validation",id:"periodic-validation",level:3},{value:"IAPKit Subscription States",id:"iapkit-subscription-states",level:2},{value:"Next Steps",id:"next-steps",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"subscription-flow",children:"Subscription Flow"}),"\n",(0,s.jsx)(t.A,{}),"\n",(0,s.jsx)(n.h2,{id:"key-concepts",children:"Key Concepts"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"ProductQueryType.Subs"})," to fetch subscription products"]}),"\n",(0,s.jsxs)(n.li,{children:["Android requires ",(0,s.jsx)(n.code,{children:"offerToken"})," for subscription purchases"]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"getActiveSubscriptions()"})," to check subscription status"]}),"\n",(0,s.jsxs)(n.li,{children:["Always set ",(0,s.jsx)(n.code,{children:"isConsumable = false"})," when finishing subscription transactions"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"fetch-subscriptions",children:"Fetch Subscriptions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'val subscriptions = kmpIapInstance.fetchProducts {\n    skus = listOf("premium_monthly", "premium_yearly")\n    type = ProductQueryType.Subs\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"check-active-subscriptions",children:"Check Active Subscriptions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'// Quick check\nval hasActive = kmpIapInstance.hasActiveSubscriptions(subscriptionIds)\n\n// Detailed info\nval activeSubscriptions = kmpIapInstance.getActiveSubscriptions(subscriptionIds)\nactiveSubscriptions.forEach { sub ->\n    println("Product: ${sub.productId}")\n    println("Expires: ${sub.expirationDateIOS}")      // iOS\n    println("Auto-renewing: ${sub.autoRenewingAndroid}") // Android\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"request-subscription",children:"Request Subscription"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'// Get offer token for Android\nval product = subscriptions.find { it.productId == "premium_monthly" }\nval offerToken = product?.subscriptionOffers?.firstOrNull()?.offerToken\n\nkmpIapInstance.requestPurchase {\n    ios { sku = "premium_monthly" }\n    android {\n        skus = listOf("premium_monthly")\n        subscriptionOffers = offerToken?.let {\n            listOf(SubscriptionOfferAndroid(sku = "premium_monthly", offerToken = it))\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"finish-transaction",children:"Finish Transaction"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"kmpIapInstance.finishTransaction(\n    purchase = purchase.toPurchaseInput(),\n    isConsumable = false  // Subscriptions are never consumable\n)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"platform-specific-info",children:"Platform-Specific Info"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Feature"}),(0,s.jsx)(n.th,{children:"iOS"}),(0,s.jsx)(n.th,{children:"Android"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Expiration"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"expirationDateIOS"})}),(0,s.jsx)(n.td,{children:"Server-side"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Environment"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"environmentIOS"})}),(0,s.jsx)(n.td,{children:"N/A"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Auto-renew"}),(0,s.jsx)(n.td,{children:"N/A"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"autoRenewingAndroid"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Manage subs"}),(0,s.jsx)(n.td,{children:"App Store"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"deepLinkToSubscriptions()"})})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"android-subscription-management",children:"Android Subscription Management"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'if (kmpIapInstance.getPlatform() == IapPlatform.Android) {\n    kmpIapInstance.deepLinkToSubscriptions("premium_monthly")\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"iapkit-server-verification",children:"IAPKit Server Verification"}),"\n",(0,s.jsx)(n.p,{children:"For subscription apps, server-side verification is critical for managing access control and handling renewals."}),"\n",(0,s.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Get your API key from ",(0,s.jsx)(c.A,{children:"iapkit.com"})]}),"\n",(0,s.jsxs)(n.li,{children:["Configure environment variables (see ",(0,s.jsx)(n.a,{href:"/kmp-iap/docs/1.0.0/examples/purchase-flow#setup",children:"Purchase Flow"})," for details)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"subscription-verification",children:"Subscription Verification"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'kmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n    val purchaseToken = purchase.purchaseToken\n    if (purchaseToken.isNullOrEmpty()) {\n        showError("No purchase token available")\n        return@collect\n    }\n\n    try {\n        val result = kmpIapInstance.verifyPurchaseWithProvider(\n            VerifyPurchaseWithProviderProps(\n                provider = PurchaseVerificationProvider.Iapkit,\n                iapkit = RequestVerifyPurchaseWithIapkitProps(\n                    apiKey = AppConfig.iapkitApiKey,\n                    apple = RequestVerifyPurchaseWithIapkitAppleProps(jws = purchaseToken),\n                    google = RequestVerifyPurchaseWithIapkitGoogleProps(purchaseToken = purchaseToken)\n                )\n            )\n        )\n\n        when (result.iapkit?.state) {\n            IapkitPurchaseState.Entitled -> {\n                // Active subscription - grant access\n                grantSubscriptionAccess(purchase.productId)\n                kmpIapInstance.finishTransaction(\n                    purchase = purchase.toPurchaseInput(),\n                    isConsumable = false\n                )\n            }\n            IapkitPurchaseState.Expired -> {\n                // Subscription ended - revoke access\n                revokeSubscriptionAccess(purchase.productId)\n            }\n            IapkitPurchaseState.Canceled -> {\n                // User canceled but may still have access until period ends\n                showInfo("Subscription will end at period end")\n            }\n            IapkitPurchaseState.Inauthentic -> {\n                // Fraudulent purchase detected\n                revokeSubscriptionAccess(purchase.productId)\n                showError("Invalid purchase detected")\n            }\n            else -> {\n                showError("Unknown state: ${result.iapkit?.state}")\n            }\n        }\n    } catch (e: Exception) {\n        showError("Verification error: ${e.message}")\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"verification-response",children:"Verification Response"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "isValid": true,\n  "state": "ENTITLED",\n  "store": "APPLE"\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"// Access in code\nval isValid = result.iapkit?.isValid     // true\nval state = result.iapkit?.state         // IapkitPurchaseState.Entitled\nval store = result.iapkit?.store         // IapStore.Apple or IapStore.Google\n"})}),"\n",(0,s.jsx)(n.h3,{id:"periodic-validation",children:"Periodic Validation"}),"\n",(0,s.jsx)(n.p,{children:"For production apps, validate subscriptions periodically:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"// On app launch or every 24 hours\nsuspend fun validateActiveSubscriptions() {\n    val activeSubscriptions = kmpIapInstance.getActiveSubscriptions(subscriptionIds)\n\n    activeSubscriptions.forEach { subscription ->\n        val result = verifyWithIapkit(subscription)\n\n        when (result.iapkit?.state) {\n            IapkitPurchaseState.Entitled -> { /* Still valid */ }\n            IapkitPurchaseState.Expired,\n            IapkitPurchaseState.Canceled -> {\n                revokeSubscriptionAccess(subscription.productId)\n            }\n            else -> { /* Handle error */ }\n        }\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"iapkit-subscription-states",children:"IAPKit Subscription States"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"State"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Entitled"})}),(0,s.jsx)(n.td,{children:"Active subscription"}),(0,s.jsx)(n.td,{children:"Grant access"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Expired"})}),(0,s.jsx)(n.td,{children:"Subscription ended"}),(0,s.jsx)(n.td,{children:"Revoke access"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Canceled"})}),(0,s.jsx)(n.td,{children:"User canceled"}),(0,s.jsx)(n.td,{children:"Access until period ends"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Inauthentic"})}),(0,s.jsx)(n.td,{children:"Fraudulent"}),(0,s.jsx)(n.td,{children:"Revoke immediately"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/kmp-iap/docs/1.0.0/examples/purchase-flow",children:"Purchase Flow"})," - One-time purchases"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/kmp-iap/docs/1.0.0/api/error-codes",children:"Error Codes"})," - Handle all error types"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},5159:(e,n,i)=>{i.d(n,{A:()=>c});i(6540);var s=i(6025),r=i(7856),t=i(4848);function c({className:e="iapkit-banner",style:n}){const i=(0,s.A)("/img/iapkit-banner.gif");return(0,t.jsx)("div",{className:e,style:n,children:(0,t.jsx)("a",{href:r.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(r.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track banner click:",e)}},style:{display:"block",textAlign:"center",marginBottom:"20px",textDecoration:"none",cursor:"pointer"},children:(0,t.jsx)("img",{src:i,alt:"IAPKit - In-App Purchase Made Simple",style:{height:"auto",borderRadius:"8px",objectFit:"contain"}})})})}},7856:(e,n,i)=>{i.d(n,{I:()=>r,V:()=>s});const s="https://iapkit.com",r="https://www.hyo.dev/api/ad-banner/cmjf0l20n0002249hjrwmgob3"},8453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>o});var s=i(6540);const r={},t=s.createContext(r);function c(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);