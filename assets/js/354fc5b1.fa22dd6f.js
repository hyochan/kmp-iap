"use strict";(self.webpackChunkkmp_iap_docs=self.webpackChunkkmp_iap_docs||[]).push([[18],{1437:(e,i,n)=>{n.d(i,{A:()=>t});n(6540);var s=n(7856),r=n(4848);function t({children:e,href:i,className:n,style:t}){return(0,r.jsx)("a",{href:i||s.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(s.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track link click:",e)}},className:n,style:t,children:e})}},1907:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var s=n(4848),r=n(8453),t=n(5159),c=n(1437);const o={sidebar_position:2,title:"Subscription Flow"},a="Subscription Flow",l={id:"examples/subscription-flow",title:"Subscription Flow",description:"Key Concepts",source:"@site/versioned_docs/version-1.2.0/examples/subscription-flow.md",sourceDirName:"examples",slug:"/examples/subscription-flow",permalink:"/kmp-iap/docs/1.2.0/examples/subscription-flow",draft:!1,unlisted:!1,editUrl:"https://github.com/hyochan/kmp-iap/tree/main/docs/versioned_docs/version-1.2.0/examples/subscription-flow.md",tags:[],version:"1.2.0",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Subscription Flow"},sidebar:"docsSidebar",previous:{title:"Purchase Flow",permalink:"/kmp-iap/docs/1.2.0/examples/purchase-flow"},next:{title:"Complete Implementation",permalink:"/kmp-iap/docs/1.2.0/examples/complete-implementation"}},d={},p=[{value:"Key Concepts",id:"key-concepts",level:2},{value:"Fetch Subscriptions",id:"fetch-subscriptions",level:2},{value:"Check Active Subscriptions",id:"check-active-subscriptions",level:2},{value:"Request Subscription",id:"request-subscription",level:2},{value:"Finish Transaction",id:"finish-transaction",level:2},{value:"Platform-Specific Info",id:"platform-specific-info",level:2},{value:"Android Subscription Management",id:"android-subscription-management",level:2},{value:"IAPKit Server Verification",id:"iapkit-server-verification",level:2},{value:"Setup",id:"setup",level:3},{value:"Subscription Verification",id:"subscription-verification",level:3},{value:"Verification Response",id:"verification-response",level:3},{value:"Periodic Validation",id:"periodic-validation",level:3},{value:"IAPKit Subscription States",id:"iapkit-subscription-states",level:2},{value:"Android basePlanId Limitation",id:"baseplanid-limitation",level:2},{value:"Client-Side Limitation",id:"client-side-limitation",level:3},{value:"Solution: Server-Side Verification with IAPKit",id:"solution-server-side-verification-with-iapkit",level:3},{value:"Next Steps",id:"next-steps",level:2}];function h(e){const i={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.h1,{id:"subscription-flow",children:"Subscription Flow"}),"\n",(0,s.jsx)(t.A,{}),"\n",(0,s.jsx)(i.h2,{id:"key-concepts",children:"Key Concepts"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["Use ",(0,s.jsx)(i.code,{children:"ProductQueryType.Subs"})," to fetch subscription products"]}),"\n",(0,s.jsxs)(i.li,{children:["Android requires ",(0,s.jsx)(i.code,{children:"offerToken"})," for subscription purchases"]}),"\n",(0,s.jsxs)(i.li,{children:["Use ",(0,s.jsx)(i.code,{children:"getActiveSubscriptions()"})," to check subscription status"]}),"\n",(0,s.jsxs)(i.li,{children:["Always set ",(0,s.jsx)(i.code,{children:"isConsumable = false"})," when finishing subscription transactions"]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"fetch-subscriptions",children:"Fetch Subscriptions"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:'val subscriptions = kmpIapInstance.fetchProducts {\n    skus = listOf("premium_monthly", "premium_yearly")\n    type = ProductQueryType.Subs\n}\n'})}),"\n",(0,s.jsx)(i.h2,{id:"check-active-subscriptions",children:"Check Active Subscriptions"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:'// Quick check\nval hasActive = kmpIapInstance.hasActiveSubscriptions(subscriptionIds)\n\n// Detailed info\nval activeSubscriptions = kmpIapInstance.getActiveSubscriptions(subscriptionIds)\nactiveSubscriptions.forEach { sub ->\n    println("Product: ${sub.productId}")\n    println("Expires: ${sub.expirationDateIOS}")      // iOS\n    println("Auto-renewing: ${sub.autoRenewingAndroid}") // Android\n}\n'})}),"\n",(0,s.jsx)(i.h2,{id:"request-subscription",children:"Request Subscription"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:'// Get offer token for Android\nval product = subscriptions.find { it.productId == "premium_monthly" }\nval offerToken = product?.subscriptionOffers?.firstOrNull()?.offerToken\n\nkmpIapInstance.requestPurchase {\n    ios { sku = "premium_monthly" }\n    google {  // Recommended (v1.3.15+)\n        skus = listOf("premium_monthly")\n        subscriptionOffers = offerToken?.let {\n            listOf(SubscriptionOfferAndroid(sku = "premium_monthly", offerToken = it))\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(i.h2,{id:"finish-transaction",children:"Finish Transaction"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:"kmpIapInstance.finishTransaction(\n    purchase = purchase.toPurchaseInput(),\n    isConsumable = false  // Subscriptions are never consumable\n)\n"})}),"\n",(0,s.jsx)(i.h2,{id:"platform-specific-info",children:"Platform-Specific Info"}),"\n",(0,s.jsxs)(i.table,{children:[(0,s.jsx)(i.thead,{children:(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.th,{children:"Feature"}),(0,s.jsx)(i.th,{children:"iOS"}),(0,s.jsx)(i.th,{children:"Android"})]})}),(0,s.jsxs)(i.tbody,{children:[(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:"Expiration"}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"expirationDateIOS"})}),(0,s.jsx)(i.td,{children:"Server-side"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:"Environment"}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"environmentIOS"})}),(0,s.jsx)(i.td,{children:"N/A"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:"Auto-renew"}),(0,s.jsx)(i.td,{children:"N/A"}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"autoRenewingAndroid"})})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:"Manage subs"}),(0,s.jsx)(i.td,{children:"App Store"}),(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"deepLinkToSubscriptions()"})})]})]})]}),"\n",(0,s.jsx)(i.h2,{id:"android-subscription-management",children:"Android Subscription Management"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:'if (kmpIapInstance.getPlatform() == IapPlatform.Android) {\n    kmpIapInstance.deepLinkToSubscriptions("premium_monthly")\n}\n'})}),"\n",(0,s.jsx)(i.h2,{id:"iapkit-server-verification",children:"IAPKit Server Verification"}),"\n",(0,s.jsx)(i.p,{children:"For subscription apps, server-side verification is critical for managing access control and handling renewals."}),"\n",(0,s.jsx)(i.h3,{id:"setup",children:"Setup"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:["Get your API key from ",(0,s.jsx)(c.A,{children:"iapkit.com"})]}),"\n",(0,s.jsxs)(i.li,{children:["Configure environment variables (see ",(0,s.jsx)(i.a,{href:"/kmp-iap/docs/1.2.0/examples/purchase-flow#setup",children:"Purchase Flow"})," for details)"]}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"subscription-verification",children:"Subscription Verification"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:'kmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n    val purchaseToken = purchase.purchaseToken\n    if (purchaseToken.isNullOrEmpty()) {\n        showError("No purchase token available")\n        return@collect\n    }\n\n    try {\n        val result = kmpIapInstance.verifyPurchaseWithProvider(\n            VerifyPurchaseWithProviderProps(\n                provider = PurchaseVerificationProvider.Iapkit,\n                iapkit = RequestVerifyPurchaseWithIapkitProps(\n                    apiKey = AppConfig.iapkitApiKey,\n                    apple = RequestVerifyPurchaseWithIapkitAppleProps(jws = purchaseToken),\n                    google = RequestVerifyPurchaseWithIapkitGoogleProps(purchaseToken = purchaseToken)\n                )\n            )\n        )\n\n        when (result.iapkit?.state) {\n            IapkitPurchaseState.Entitled -> {\n                // Active subscription - grant access\n                grantSubscriptionAccess(purchase.productId)\n                kmpIapInstance.finishTransaction(\n                    purchase = purchase.toPurchaseInput(),\n                    isConsumable = false\n                )\n            }\n            IapkitPurchaseState.Expired -> {\n                // Subscription ended - revoke access\n                revokeSubscriptionAccess(purchase.productId)\n            }\n            IapkitPurchaseState.Canceled -> {\n                // User canceled but may still have access until period ends\n                showInfo("Subscription will end at period end")\n            }\n            IapkitPurchaseState.Inauthentic -> {\n                // Fraudulent purchase detected\n                revokeSubscriptionAccess(purchase.productId)\n                showError("Invalid purchase detected")\n            }\n            else -> {\n                showError("Unknown state: ${result.iapkit?.state}")\n            }\n        }\n    } catch (e: Exception) {\n        showError("Verification error: ${e.message}")\n    }\n}\n'})}),"\n",(0,s.jsx)(i.h3,{id:"verification-response",children:"Verification Response"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-json",children:'{\n  "isValid": true,\n  "state": "ENTITLED",\n  "store": "APPLE"\n}\n'})}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:"// Access in code\nval isValid = result.iapkit?.isValid     // true\nval state = result.iapkit?.state         // IapkitPurchaseState.Entitled\nval store = result.iapkit?.store         // IapStore.Apple or IapStore.Google\n"})}),"\n",(0,s.jsx)(i.h3,{id:"periodic-validation",children:"Periodic Validation"}),"\n",(0,s.jsx)(i.p,{children:"For production apps, validate subscriptions periodically:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:"// On app launch or every 24 hours\nsuspend fun validateActiveSubscriptions() {\n    val activeSubscriptions = kmpIapInstance.getActiveSubscriptions(subscriptionIds)\n\n    activeSubscriptions.forEach { subscription ->\n        val result = verifyWithIapkit(subscription)\n\n        when (result.iapkit?.state) {\n            IapkitPurchaseState.Entitled -> { /* Still valid */ }\n            IapkitPurchaseState.Expired,\n            IapkitPurchaseState.Canceled -> {\n                revokeSubscriptionAccess(subscription.productId)\n            }\n            else -> { /* Handle error */ }\n        }\n    }\n}\n"})}),"\n",(0,s.jsx)(i.h2,{id:"iapkit-subscription-states",children:"IAPKit Subscription States"}),"\n",(0,s.jsxs)(i.table,{children:[(0,s.jsx)(i.thead,{children:(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.th,{children:"State"}),(0,s.jsx)(i.th,{children:"Description"}),(0,s.jsx)(i.th,{children:"Action"})]})}),(0,s.jsxs)(i.tbody,{children:[(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Entitled"})}),(0,s.jsx)(i.td,{children:"Active subscription"}),(0,s.jsx)(i.td,{children:"Grant access"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Expired"})}),(0,s.jsx)(i.td,{children:"Subscription ended"}),(0,s.jsx)(i.td,{children:"Revoke access"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Canceled"})}),(0,s.jsx)(i.td,{children:"User canceled"}),(0,s.jsx)(i.td,{children:"Access until period ends"})]}),(0,s.jsxs)(i.tr,{children:[(0,s.jsx)(i.td,{children:(0,s.jsx)(i.code,{children:"Inauthentic"})}),(0,s.jsx)(i.td,{children:"Fraudulent"}),(0,s.jsx)(i.td,{children:"Revoke immediately"})]})]})]}),"\n",(0,s.jsx)(i.h2,{id:"baseplanid-limitation",children:"Android basePlanId Limitation"}),"\n",(0,s.jsx)(i.h3,{id:"client-side-limitation",children:"Client-Side Limitation"}),"\n",(0,s.jsxs)(i.p,{children:["The ",(0,s.jsx)(i.code,{children:"basePlanId"})," is available when fetching products, but ",(0,s.jsx)(i.strong,{children:"not"})," when retrieving purchases via ",(0,s.jsx)(i.code,{children:"getAvailablePurchases()"}),". This is a limitation of Google Play Billing Library - the purchase token alone doesn't reveal which base plan was purchased."]}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsxs)(i.p,{children:["See ",(0,s.jsx)(i.a,{href:"https://github.com/hyochan/react-native-iap/issues/3096",children:"GitHub Issue #3096"})," for more details."]}),"\n"]}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.strong,{children:"Why this matters:"})}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsx)(i.li,{children:"If you have multiple base plans (e.g., monthly, yearly, premium), you cannot determine which plan the user is subscribed to using client-side APIs alone"}),"\n",(0,s.jsxs)(i.li,{children:["The ",(0,s.jsx)(i.code,{children:"basePlanId"})," is only available from ",(0,s.jsx)(i.code,{children:"subscriptionOfferDetailsAndroid"})," at the time of purchase, not from restored purchases"]}),"\n"]}),"\n",(0,s.jsx)(i.h3,{id:"solution-server-side-verification-with-iapkit",children:"Solution: Server-Side Verification with IAPKit"}),"\n",(0,s.jsxs)(i.p,{children:["Use the ",(0,s.jsx)(i.code,{children:"verifyPurchaseWithProvider"})," function to get complete subscription details including ",(0,s.jsx)(i.code,{children:"basePlanId"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-kotlin",children:'val verifyAndroidSubscription = suspend fun(purchase: Purchase) {\n    val result = kmpIapInstance.verifyPurchaseWithProvider(\n        VerifyPurchaseWithProviderProps(\n            provider = PurchaseVerificationProvider.Iapkit,\n            iapkit = RequestVerifyPurchaseWithIapkitProps(\n                apiKey = AppConfig.iapkitApiKey,\n                google = RequestVerifyPurchaseWithIapkitGoogleProps(\n                    purchaseToken = purchase.purchaseToken\n                )\n            )\n        )\n    )\n\n    // Response includes offerDetails.basePlanId in lineItems\n    val basePlanId = result.providerResponse\n        ?.get("lineItems")\n        ?.let { (it as? List<*>)?.firstOrNull() as? Map<*, *> }\n        ?.get("offerDetails")\n        ?.let { (it as? Map<*, *>)?.get("basePlanId") as? String }\n\n    println("Subscribed to base plan: $basePlanId")\n}\n'})}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsxs)(i.p,{children:["See ",(0,s.jsx)(i.a,{href:"https://www.openiap.dev/docs/apis#verifypurchasewithprovider",children:"verifyPurchaseWithProvider"})]}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["The server response includes ",(0,s.jsx)(i.code,{children:"offerDetails.basePlanId"})," in the ",(0,s.jsx)(i.code,{children:"lineItems"})," array, allowing you to identify exactly which subscription plan the user purchased."]}),"\n",(0,s.jsx)(i.admonition,{title:"Subscription Offers",type:"tip",children:(0,s.jsxs)(i.p,{children:["When fetching products, each subscription offer includes: ",(0,s.jsx)(i.code,{children:"basePlanId"}),", ",(0,s.jsx)(i.code,{children:"offerId?"}),", ",(0,s.jsx)(i.code,{children:"offerTags"}),", ",(0,s.jsx)(i.code,{children:"offerToken"}),", and ",(0,s.jsx)(i.code,{children:"pricingPhases"}),". See ",(0,s.jsx)(i.a,{href:"https://www.openiap.dev/docs/types#productsubscriptionandroidofferdetails",children:"ProductSubscriptionAndroidOfferDetails"})," for more details."]})}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsxs)(i.p,{children:["See ",(0,s.jsx)(c.A,{children:"IAPKit documentation"})," for setup instructions and API details."]}),"\n"]}),"\n",(0,s.jsx)(i.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.a,{href:"/kmp-iap/docs/1.2.0/examples/purchase-flow",children:"Purchase Flow"})," - One-time purchases"]}),"\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.a,{href:"/kmp-iap/docs/1.2.0/api/error-codes",children:"Error Codes"})," - Handle all error types"]}),"\n"]})]})}function u(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},5159:(e,i,n)=>{n.d(i,{A:()=>c});n(6540);var s=n(6025),r=n(7856),t=n(4848);function c({className:e="iapkit-banner",style:i}){const n=(0,s.A)("/img/iapkit-banner.gif");return(0,t.jsx)("div",{className:e,style:i,children:(0,t.jsx)("a",{href:r.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(r.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track banner click:",e)}},style:{display:"block",textAlign:"center",marginBottom:"20px",textDecoration:"none",cursor:"pointer"},children:(0,t.jsx)("img",{src:n,alt:"IAPKit - In-App Purchase Made Simple",style:{height:"auto",borderRadius:"8px",objectFit:"contain"}})})})}},7856:(e,i,n)=>{n.d(i,{I:()=>r,V:()=>s});const s="https://iapkit.com",r="https://www.hyo.dev/api/ad-banner/cmjf0l20n0002249hjrwmgob3"},8453:(e,i,n)=>{n.d(i,{R:()=>c,x:()=>o});var s=n(6540);const r={},t=s.createContext(r);function c(e){const i=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:i},e.children)}}}]);