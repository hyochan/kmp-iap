"use strict";(self.webpackChunkkmp_iap_docs=self.webpackChunkkmp_iap_docs||[]).push([[5359],{1577:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>t,metadata:()=>l,toc:()=>d});var r=i(4848),s=i(8453),o=i(5159);const t={sidebar_position:7,title:"Subscription Offers"},c="Subscription Offers",l={id:"guides/subscription-offers",title:"Subscription Offers",description:"This guide explains how to handle subscription offers (pricing plans) when purchasing subscriptions on iOS and Android platforms.",source:"@site/docs/guides/subscription-offers.md",sourceDirName:"guides",slug:"/guides/subscription-offers",permalink:"/kmp-iap/docs/guides/subscription-offers",draft:!1,unlisted:!1,editUrl:"https://github.com/hyochan/kmp-iap/tree/main/docs/docs/guides/subscription-offers.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7,title:"Subscription Offers"}},a={},d=[{value:"Overview",id:"overview",level:2},{value:"Platform Differences",id:"platform-differences",level:2},{value:"Android Subscription Offers",id:"android-subscription-offers",level:3},{value:"Required for Android Subscriptions",id:"required-for-android-subscriptions",level:4},{value:"Getting Offer Tokens",id:"getting-offer-tokens",level:4},{value:"Purchase with Offers",id:"purchase-with-offers",level:4},{value:"Understanding Offer Details",id:"understanding-offer-details",level:4},{value:"iOS Subscription Offers",id:"ios-subscription-offers",level:3},{value:"Base Plan (Default)",id:"base-plan-default",level:4},{value:"Introductory Offers",id:"introductory-offers",level:4},{value:"Promotional Offers (Optional)",id:"promotional-offers-optional",level:4},{value:"Getting Available Promotional Offers",id:"getting-available-promotional-offers",level:5},{value:"Applying Promotional Offers",id:"applying-promotional-offers",level:5},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Selecting Specific Offers",id:"selecting-specific-offers",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Android Errors",id:"android-errors",level:3},{value:"iOS Errors",id:"ios-errors",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"See Also",id:"see-also",level:2}];function f(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"subscription-offers",children:"Subscription Offers"}),"\n",(0,r.jsx)(o.A,{}),"\n",(0,r.jsx)(n.p,{children:"This guide explains how to handle subscription offers (pricing plans) when purchasing subscriptions on iOS and Android platforms."}),"\n",(0,r.jsxs)(n.p,{children:["For a complete implementation example, see the ",(0,r.jsx)(n.a,{href:"/kmp-iap/docs/examples/subscription-flow",children:"Subscription Flow Example"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"Subscription offers represent different pricing plans for the same subscription product:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Base Plan"}),": The standard pricing for a subscription"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Introductory Offers"}),": Special pricing for new subscribers (free trial, discounted period)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Promotional Offers"}),": Limited-time discounts configured in the app stores"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"platform-differences",children:"Platform Differences"}),"\n",(0,r.jsx)(n.p,{children:"At a glance:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Android: subscription offers are required when purchasing subscriptions. You must pass ",(0,r.jsx)(n.code,{children:"subscriptionOffers"})," with one or more offer tokens from ",(0,r.jsx)(n.code,{children:"fetchProducts()"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["iOS: base plan is used by default. Promotional discounts are optional via ",(0,r.jsx)(n.code,{children:"withOffer"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["Always fetch products first; offers only exist after ",(0,r.jsx)(n.code,{children:"fetchProducts { type = ProductQueryType.Subs }"}),"."]})}),"\n",(0,r.jsx)(n.h3,{id:"android-subscription-offers",children:"Android Subscription Offers"}),"\n",(0,r.jsxs)(n.p,{children:["Android requires explicit specification of subscription offers when purchasing. Each offer is identified by an ",(0,r.jsx)(n.code,{children:"offerToken"})," obtained from ",(0,r.jsx)(n.code,{children:"fetchProducts()"}),"."]}),"\n",(0,r.jsx)(n.h4,{id:"required-for-android-subscriptions",children:"Required for Android Subscriptions"}),"\n",(0,r.jsxs)(n.p,{children:["Unlike iOS, Android subscriptions ",(0,r.jsx)(n.strong,{children:"must"})," include ",(0,r.jsx)(n.code,{children:"subscriptionOffers"})," in the purchase request. Without it, the purchase will fail with:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"The number of skus (1) must match: the number of offerTokens (0)\n"})}),"\n",(0,r.jsx)(n.h4,{id:"getting-offer-tokens",children:"Getting Offer Tokens"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'// 1) Fetch subscription products\nval subscriptions = kmpIapInstance.fetchProducts {\n    skus = listOf("premium_monthly")\n    type = ProductQueryType.Subs\n}\n\n// 2) Access offer details from fetched subscriptions\nval subscription = subscriptions.find { it.productId == "premium_monthly" }\n\nif (subscription is ProductSubscriptionAndroid) {\n    println("Available offers: ${subscription.subscriptionOffers}")\n    // Each offer contains: id, displayPrice, paymentMode, period, offerTokenAndroid, pricingPhasesAndroid\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"purchase-with-offers",children:"Purchase with Offers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'suspend fun purchaseSubscription(subscriptionId: String) {\n    val subscription = subscriptions.find { it.productId == subscriptionId }\n    if (subscription == null) return\n\n    // Build subscriptionOffers from fetched data using cross-platform subscriptionOffers\n    val offers = when (subscription) {\n        is ProductSubscriptionAndroid -> {\n            subscription.subscriptionOffers\n                .filter { it.offerTokenAndroid != null }\n                .map { offer ->\n                    SubscriptionOfferAndroid(\n                        sku = subscriptionId,\n                        offerToken = offer.offerTokenAndroid!!\n                    )\n                }\n        }\n        else -> emptyList()\n    }\n\n    // Only proceed if offers are available\n    if (offers.isEmpty()) {\n        println("No subscription offers available")\n        return\n    }\n\n    kmpIapInstance.requestPurchase {\n        apple { sku = subscriptionId }\n        google {\n            skus = listOf(subscriptionId)\n            subscriptionOffers = offers\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"understanding-offer-details",children:"Understanding Offer Details"}),"\n",(0,r.jsxs)(n.p,{children:["Each ",(0,r.jsx)(n.code,{children:"subscriptionOffers"})," item contains (cross-platform ",(0,r.jsx)(n.code,{children:"SubscriptionOffer"})," type):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'data class SubscriptionOffer(\n    val id: String?,                           // Unique identifier for the offer\n    val displayPrice: String?,                 // Formatted price string (e.g., "$9.99/month")\n    val price: Double?,                        // Numeric price value\n    val currency: String?,                     // Currency code (ISO 4217)\n    val type: DiscountOfferType?,              // Introductory, Promotional, OneTime\n    val paymentMode: PaymentMode?,             // FreeTrial, PayAsYouGo, PayUpFront\n    val period: SubscriptionPeriod?,           // Subscription period (unit + value)\n    val periodCount: Int?,                     // Number of periods the offer applies\n\n    // Android-specific fields\n    val basePlanIdAndroid: String?,            // Base plan identifier\n    val offerTokenAndroid: String?,            // Token required for purchase\n    val offerTagsAndroid: List<String>?,       // Tags associated with the offer\n    val pricingPhasesAndroid: PricingPhasesAndroid?, // Detailed pricing phases\n\n    // iOS-specific fields\n    val keyIdentifierIOS: String?,             // Key identifier for signature validation\n    val nonceIOS: String?,                     // Cryptographic nonce (UUID)\n    val signatureIOS: String?,                 // Server-generated signature\n    val timestampIOS: Long?                    // Timestamp when signature was generated\n)\n'})}),"\n",(0,r.jsxs)(n.admonition,{title:"Android basePlanId Limitation",type:"warning",children:[(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"basePlanId"})," is available when fetching products, but not when retrieving purchases via ",(0,r.jsx)(n.code,{children:"getAvailablePurchases()"}),". This is a limitation of Google Play Billing Library - the purchase token alone doesn't reveal which base plan was purchased."]}),(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"https://github.com/hyochan/react-native-iap/issues/3096",children:"GitHub Issue #3096"})," for more details. See the ",(0,r.jsx)(n.a,{href:"/kmp-iap/docs/guides/subscription-validation#android-baseplanid-limitation",children:"basePlanId Limitation"})," section for details and workarounds."]})]}),"\n",(0,r.jsx)(n.h3,{id:"ios-subscription-offers",children:"iOS Subscription Offers"}),"\n",(0,r.jsx)(n.p,{children:"iOS handles subscription offers differently - the base plan is used by default, and promotional offers are optional."}),"\n",(0,r.jsx)(n.h4,{id:"base-plan-default",children:"Base Plan (Default)"}),"\n",(0,r.jsx)(n.p,{children:"For standard subscription purchases, no special offer specification is needed:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'kmpIapInstance.requestPurchase {\n    apple { sku = "premium_monthly" }\n    google {\n        skus = listOf("premium_monthly")\n        // include subscriptionOffers only if available\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"introductory-offers",children:"Introductory Offers"}),"\n",(0,r.jsx)(n.p,{children:"iOS automatically applies introductory prices (free trials, intro pricing) configured in App Store Connect. No additional code is needed - users will see the introductory offer when eligible."}),"\n",(0,r.jsx)(n.p,{children:"To check if a subscription has an introductory offer:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'val subscription = subscriptions.find { it.productId == "premium_monthly" }\n\nif (subscription is ProductSubscriptionIOS) {\n    subscription.introductoryDiscountIOS?.let { offer ->\n        when (offer.paymentMode) {\n            PaymentMode.FreeTrial -> {\n                println("${offer.periodCount} ${offer.period?.unit} free trial")\n            }\n            PaymentMode.PayAsYouGo -> {\n                println("${offer.displayPrice} for ${offer.periodCount} ${offer.period?.unit}")\n            }\n            PaymentMode.PayUpFront -> {\n                println("${offer.displayPrice} for first ${offer.periodCount} ${offer.period?.unit}")\n            }\n            else -> {}\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h4,{id:"promotional-offers-optional",children:"Promotional Offers (Optional)"}),"\n",(0,r.jsxs)(n.p,{children:["iOS supports promotional offers through the ",(0,r.jsx)(n.code,{children:"withOffer"})," parameter. These are server-to-server offers that require signature generation from your backend."]}),"\n",(0,r.jsx)(n.h5,{id:"getting-available-promotional-offers",children:"Getting Available Promotional Offers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'val subscription = subscriptions.find { it.productId == "premium_monthly" }\n\nif (subscription is ProductSubscriptionIOS) {\n    subscription.discountsIOS?.forEach { discount ->\n        println("- Identifier: ${discount.identifier}")\n        println("  Price: ${discount.localizedPrice}")\n        println("  Payment mode: ${discount.paymentMode}")\n        println("  Period: ${discount.subscriptionPeriod}")\n        println("  Number of periods: ${discount.numberOfPeriods}")\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h5,{id:"applying-promotional-offers",children:"Applying Promotional Offers"}),"\n",(0,r.jsxs)(n.p,{children:["To apply a promotional offer, you need to generate a signature on your backend server. See ",(0,r.jsx)(n.a,{href:"https://developer.apple.com/documentation/storekit/in-app_purchase/original_api_for_in-app_purchase/subscriptions_and_offers/generating_a_signature_for_promotional_offers",children:"Apple's documentation"})," for signature generation."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:"suspend fun purchaseWithPromotionalOffer(\n    subscriptionId: String,\n    offerId: String\n) {\n    // 1. Generate signature on your backend\n    val nonce = UUID.randomUUID().toString()\n    val timestamp = System.currentTimeMillis()\n\n    val signatureResponse = fetchSignatureFromBackend(\n        productId = subscriptionId,\n        offerId = offerId,\n        nonce = nonce,\n        timestamp = timestamp\n    )\n\n    // 2. Purchase with the promotional offer\n    kmpIapInstance.requestPurchase {\n        apple {\n            sku = subscriptionId\n            withOffer = DiscountOfferInputIOS(\n                identifier = offerId,\n                keyIdentifier = signatureResponse.keyIdentifier,\n                nonce = nonce,\n                signature = signatureResponse.signature,\n                timestamp = timestamp\n            )\n        }\n        google {\n            skus = listOf(subscriptionId)\n            subscriptionOffers = listOf(/* ... */)\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,r.jsx)(n.h3,{id:"selecting-specific-offers",children:"Selecting Specific Offers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'fun selectOffer(\n    subscription: Product,\n    offerType: OfferType\n): SubscriptionOffer? {\n    return when (subscription) {\n        is ProductSubscriptionIOS -> {\n            // iOS: Check for introductory offer\n            if (offerType == OfferType.INTRODUCTORY) {\n                // Access introductory offer from subscriptionOffers\n                subscription.subscriptionOffers?.find {\n                    it.type == DiscountOfferType.Introductory\n                }\n            } else {\n                // Base plan is default, no selection needed\n                null\n            }\n        }\n        is ProductSubscriptionAndroid -> {\n            // Android: Select offer based on type using cross-platform subscriptionOffers\n            val offers = subscription.subscriptionOffers\n\n            when (offerType) {\n                OfferType.BASE -> {\n                    // Find base plan (offer without introductory/promotional type)\n                    offers.find { it.type == null || it.type == DiscountOfferType.OneTime }\n                }\n                OfferType.INTRODUCTORY -> {\n                    // Find introductory offer\n                    offers.find { it.type == DiscountOfferType.Introductory }\n                }\n            }\n        }\n        else -> null\n    }\n}\n\nenum class OfferType {\n    BASE,\n    INTRODUCTORY\n}\n\nsuspend fun purchaseWithSelectedOffer(\n    subscriptionId: String,\n    offerType: OfferType = OfferType.BASE\n) {\n    val subscription = subscriptions.find { it.productId == subscriptionId }\n    if (subscription == null) return\n\n    val selectedOffer = selectOffer(subscription, offerType)\n\n    when (subscription) {\n        is ProductSubscriptionAndroid -> {\n            val subscriptionOffers = selectedOffer?.offerTokenAndroid?.let { token ->\n                listOf(SubscriptionOfferAndroid(sku = subscriptionId, offerToken = token))\n            } ?: emptyList()\n\n            if (subscriptionOffers.isEmpty()) {\n                println("No suitable offer found")\n                return\n            }\n\n            kmpIapInstance.requestPurchase {\n                apple { sku = subscriptionId }\n                google {\n                    skus = listOf(subscriptionId)\n                    subscriptionOffers = subscriptionOffers\n                }\n            }\n        }\n        is ProductSubscriptionIOS -> {\n            // iOS: Introductory offers are automatically applied\n            // selectedOffer contains intro price info for display purposes\n            if (offerType == OfferType.INTRODUCTORY && selectedOffer != null) {\n                println("Offer: ${selectedOffer.displayPrice}")\n                println("Payment mode: ${selectedOffer.paymentMode}")\n            }\n\n            kmpIapInstance.requestPurchase {\n                apple { sku = subscriptionId }\n                google {\n                    skus = listOf(subscriptionId)\n                    // include subscriptionOffers only if available\n                }\n            }\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsx)(n.h3,{id:"android-errors",children:"Android Errors"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'kmpIapInstance.purchaseErrorListener.collect { error ->\n    when (error.code) {\n        IapErrorCode.PURCHASE_ERROR -> {\n            println("Purchase failed - check subscription offers")\n            // Ensure subscriptionOffers is included and valid\n        }\n        else -> {\n            println("Error: ${error.message}")\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"ios-errors",children:"iOS Errors"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'kmpIapInstance.purchaseErrorListener.collect { error ->\n    when (error.code) {\n        IapErrorCode.UNKNOWN -> {\n            println("Invalid promotional offer for iOS")\n            // Check offerIdentifier, signature, etc.\n        }\n        else -> {\n            println("Error: ${error.message}")\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Always fetch products first"}),": Subscription offers are only available after ",(0,r.jsx)(n.code,{children:"fetchProducts()"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Handle platform differences"}),": Android requires offers, iOS makes them optional."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Validate offers"}),": Check that offers exist before attempting purchase."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"User selection"}),": Allow users to choose between different pricing plans when multiple offers are available."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Error recovery"}),": Provide fallback to base plan if selected offer fails."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/kmp-iap/docs/examples/subscription-flow",children:"Subscription Flow"})," - Complete implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/kmp-iap/docs/guides/subscription-validation",children:"Subscription Validation"})," - Validate subscription status"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/kmp-iap/docs/api/error-codes",children:"Error Codes"})," - Purchase error handling"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(f,{...e})}):f(e)}},5159:(e,n,i)=>{i.d(n,{A:()=>t});i(6540);var r=i(6025),s=i(7856),o=i(4848);function t({className:e="iapkit-banner",style:n}){const i=(0,r.A)("/img/iapkit-banner.gif");return(0,o.jsx)("div",{className:e,style:n,children:(0,o.jsx)("a",{href:s.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(s.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track banner click:",e)}},style:{display:"block",textAlign:"center",marginBottom:"20px",textDecoration:"none",cursor:"pointer"},children:(0,o.jsx)("img",{src:i,alt:"IAPKit - In-App Purchase Made Simple",style:{height:"auto",borderRadius:"8px",objectFit:"contain"}})})})}},7856:(e,n,i)=>{i.d(n,{I:()=>s,V:()=>r});const r="https://iapkit.com",s="https://www.hyo.dev/api/ad-banner/cmjf0l20n0002249hjrwmgob3"},8453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>c});var r=i(6540);const s={},o=r.createContext(s);function t(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);