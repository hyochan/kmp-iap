"use strict";(self.webpackChunkkmp_iap_docs=self.webpackChunkkmp_iap_docs||[]).push([[4245],{1437:(e,n,r)=>{r.d(n,{A:()=>t});r(6540);var s=r(7856),i=r(4848);function t({children:e,href:n,className:r,style:t}){return(0,i.jsx)("a",{href:n||s.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(s.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track link click:",e)}},className:r,style:t,children:e})}},5159:(e,n,r)=>{r.d(n,{A:()=>c});r(6540);var s=r(6025),i=r(7856),t=r(4848);function c({className:e="iapkit-banner",style:n}){const r=(0,s.A)("/img/iapkit-banner.gif");return(0,t.jsx)("div",{className:e,style:n,children:(0,t.jsx)("a",{href:i.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(i.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track banner click:",e)}},style:{display:"block",textAlign:"center",marginBottom:"20px",textDecoration:"none",cursor:"pointer"},children:(0,t.jsx)("img",{src:r,alt:"IAPKit - In-App Purchase Made Simple",style:{height:"auto",borderRadius:"8px",objectFit:"contain"}})})})}},6681:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>h});var s=r(4848),i=r(8453),t=r(5159),c=r(1437);const a={title:"Purchase Flow",sidebar_label:"Purchase Flow",sidebar_position:1},l="Purchase Flow",o={id:"examples/purchase-flow",title:"Purchase Flow",description:"Key Concepts",source:"@site/versioned_docs/version-1.2.0/examples/purchase-flow.md",sourceDirName:"examples",slug:"/examples/purchase-flow",permalink:"/kmp-iap/docs/1.2.0/examples/purchase-flow",draft:!1,unlisted:!1,editUrl:"https://github.com/hyochan/kmp-iap/tree/main/docs/versioned_docs/version-1.2.0/examples/purchase-flow.md",tags:[],version:"1.2.0",sidebarPosition:1,frontMatter:{title:"Purchase Flow",sidebar_label:"Purchase Flow",sidebar_position:1},sidebar:"docsSidebar",previous:{title:"Error Codes",permalink:"/kmp-iap/docs/1.2.0/api/error-codes"},next:{title:"Subscription Flow",permalink:"/kmp-iap/docs/1.2.0/examples/subscription-flow"}},d={},h=[{value:"Key Concepts",id:"key-concepts",level:2},{value:"Initialize",id:"initialize",level:2},{value:"Fetch Products",id:"fetch-products",level:2},{value:"Listen for Purchases",id:"listen-for-purchases",level:2},{value:"Request Purchase",id:"request-purchase",level:2},{value:"Restore Purchases",id:"restore-purchases",level:2},{value:"Cleanup",id:"cleanup",level:2},{value:"IAPKit Server Verification",id:"iapkit-server-verification",level:2},{value:"Setup",id:"setup",level:3},{value:"How It Works",id:"how-it-works",level:3},{value:"Verification Response",id:"verification-response",level:3},{value:"Verification Methods",id:"verification-methods",level:3},{value:"Benefits of IAPKit",id:"benefits-of-iapkit",level:3},{value:"IAPKit Purchase States",id:"iapkit-purchase-states",level:2},{value:"Next Steps",id:"next-steps",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"purchase-flow",children:"Purchase Flow"}),"\n",(0,s.jsx)(t.A,{}),"\n",(0,s.jsx)(n.h2,{id:"key-concepts",children:"Key Concepts"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Always call ",(0,s.jsx)(n.code,{children:"initConnection()"})," before any IAP operations"]}),"\n",(0,s.jsxs)(n.li,{children:["Listen to ",(0,s.jsx)(n.code,{children:"purchaseUpdatedListener"})," and ",(0,s.jsx)(n.code,{children:"purchaseErrorListener"})," for purchase results"]}),"\n",(0,s.jsxs)(n.li,{children:["Always call ",(0,s.jsx)(n.code,{children:"finishTransaction()"})," after processing a purchase"]}),"\n",(0,s.jsx)(n.li,{children:"Verify purchases server-side in production"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"initialize",children:"Initialize"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"kmpIapInstance.initConnection()\n"})}),"\n",(0,s.jsx)(n.h2,{id:"fetch-products",children:"Fetch Products"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'val products = kmpIapInstance.fetchProducts {\n    skus = listOf("coins_100", "premium_upgrade")\n    type = ProductQueryType.InApp\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"listen-for-purchases",children:"Listen for Purchases"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"// Success\nkmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n    // 1. Verify on server\n    // 2. Deliver content\n    // 3. Finish transaction\n    kmpIapInstance.finishTransaction(\n        purchase = purchase.toPurchaseInput(),\n        isConsumable = true\n    )\n}\n\n// Errors\nkmpIapInstance.purchaseErrorListener.collect { error ->\n    when (error.code) {\n        ErrorCode.UserCancelled -> { /* Silent */ }\n        ErrorCode.AlreadyOwned -> { /* Suggest restore */ }\n        else -> { /* Show error */ }\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"request-purchase",children:"Request Purchase"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'kmpIapInstance.requestPurchase {\n    ios {\n        sku = "coins_100"\n        // Optional: Attribution tracking (v1.3.7+)\n        // advancedCommerceData = "campaign_id"\n    }\n    google { skus = listOf("coins_100") }  // Recommended (v1.3.15+)\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"restore-purchases",children:"Restore Purchases"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"val purchases = kmpIapInstance.getAvailablePurchases()\npurchases.forEach { purchase ->\n    // Re-deliver non-consumables\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"kmpIapInstance.endConnection()\n"})}),"\n",(0,s.jsx)(n.h2,{id:"iapkit-server-verification",children:"IAPKit Server Verification"}),"\n",(0,s.jsxs)(n.p,{children:["For production apps, always verify purchases server-side. ",(0,s.jsx)(c.A,{children:"IAPKit"})," provides a simple unified API for both iOS and Android verification."]}),"\n",(0,s.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Get your API key from ",(0,s.jsx)(c.A,{children:"iapkit.com"})]}),"\n",(0,s.jsx)(n.li,{children:"Configure environment variables:"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Android"})," (",(0,s.jsx)(n.code,{children:".env"})," or ",(0,s.jsx)(n.code,{children:"local.properties"}),"):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-properties",children:"IAPKIT_API_KEY=your_api_key_here\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"iOS"})," (",(0,s.jsx)(n.code,{children:"Secrets.xcconfig"}),"):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-properties",children:"IAPKIT_API_KEY = your_api_key_here\n"})}),"\n",(0,s.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'// In your purchase listener\nkmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n    val purchaseToken = purchase.purchaseToken\n    if (purchaseToken.isNullOrEmpty()) {\n        showError("No purchase token available")\n        return@collect\n    }\n\n    try {\n        val result = kmpIapInstance.verifyPurchaseWithProvider(\n            VerifyPurchaseWithProviderProps(\n                provider = PurchaseVerificationProvider.Iapkit,\n                iapkit = RequestVerifyPurchaseWithIapkitProps(\n                    apiKey = AppConfig.iapkitApiKey,\n                    apple = RequestVerifyPurchaseWithIapkitAppleProps(jws = purchaseToken),\n                    google = RequestVerifyPurchaseWithIapkitGoogleProps(purchaseToken = purchaseToken)\n                )\n            )\n        )\n\n        if (result.iapkit?.isValid == true) {\n            // Grant entitlement to user\n            deliverProduct(purchase.productId)\n\n            // Finish the transaction\n            kmpIapInstance.finishTransaction(\n                purchase = purchase.toPurchaseInput(),\n                isConsumable = isConsumable(purchase.productId)\n            )\n        } else {\n            showError("Purchase verification failed: ${result.iapkit?.state}")\n        }\n    } catch (e: Exception) {\n        showError("Verification error: ${e.message}")\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"verification-response",children:"Verification Response"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "isValid": true,\n  "state": "ENTITLED",\n  "store": "APPLE"\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"// Access in code\nval isValid = result.iapkit?.isValid     // true\nval state = result.iapkit?.state         // IapkitPurchaseState.Entitled\nval store = result.iapkit?.store         // IapStore.Apple or IapStore.Google\n"})}),"\n",(0,s.jsx)(n.h3,{id:"verification-methods",children:"Verification Methods"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Method"}),(0,s.jsx)(n.th,{children:"Use Case"}),(0,s.jsx)(n.th,{children:"Security"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"None"})}),(0,s.jsx)(n.td,{children:"Development only"}),(0,s.jsx)(n.td,{children:"None"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Local"})}),(0,s.jsx)(n.td,{children:"Basic validation"}),(0,s.jsx)(n.td,{children:"Low"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"IAPKit"})}),(0,s.jsx)(n.td,{children:"Production apps"}),(0,s.jsx)(n.td,{children:"High"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"benefits-of-iapkit",children:"Benefits of IAPKit"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Unified API for iOS and Android"}),"\n",(0,s.jsx)(n.li,{children:"Real-time fraud detection"}),"\n",(0,s.jsx)(n.li,{children:"Subscription status tracking"}),"\n",(0,s.jsx)(n.li,{children:"Sandbox/Production environment detection"}),"\n",(0,s.jsx)(n.li,{children:"No backend infrastructure needed"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["For more details, visit the ",(0,s.jsx)(c.A,{href:"https://iapkit.com/docs",children:"IAPKit Documentation"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"iapkit-purchase-states",children:"IAPKit Purchase States"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"State"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Entitled"})}),(0,s.jsx)(n.td,{children:"Valid access"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Expired"})}),(0,s.jsx)(n.td,{children:"Subscription expired"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Canceled"})}),(0,s.jsx)(n.td,{children:"Purchase canceled"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Consumed"})}),(0,s.jsx)(n.td,{children:"Consumable used"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Inauthentic"})}),(0,s.jsx)(n.td,{children:"Fraudulent"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/kmp-iap/docs/1.2.0/examples/subscription-flow",children:"Subscription Flow"})," - Recurring payments"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/kmp-iap/docs/1.2.0/api/error-codes",children:"Error Codes"})," - Handle all error types"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},7856:(e,n,r)=>{r.d(n,{I:()=>i,V:()=>s});const s="https://iapkit.com",i="https://www.hyo.dev/api/ad-banner/cmjf0l20n0002249hjrwmgob3"},8453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>a});var s=r(6540);const i={},t=s.createContext(i);function c(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);