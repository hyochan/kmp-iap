"use strict";(self.webpackChunkkmp_iap_docs=self.webpackChunkkmp_iap_docs||[]).push([[7280],{1437:(e,n,i)=>{i.d(n,{A:()=>t});i(6540);var s=i(7856),r=i(4848);function t({children:e,href:n,className:i,style:t}){return(0,r.jsx)("a",{href:n||s.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(s.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track link click:",e)}},className:i,style:t,children:e})}},5159:(e,n,i)=>{i.d(n,{A:()=>c});i(6540);var s=i(6025),r=i(7856),t=i(4848);function c({className:e="iapkit-banner",style:n}){const i=(0,s.A)("/img/iapkit-banner.gif");return(0,t.jsx)("div",{className:e,style:n,children:(0,t.jsx)("a",{href:r.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(r.I,{method:"POST",mode:"no-cors"})}catch(e){console.error("Failed to track banner click:",e)}},style:{display:"block",textAlign:"center",marginBottom:"20px",textDecoration:"none",cursor:"pointer"},children:(0,t.jsx)("img",{src:i,alt:"IAPKit - In-App Purchase Made Simple",style:{height:"auto",borderRadius:"8px",objectFit:"contain"}})})})}},7856:(e,n,i)=>{i.d(n,{I:()=>r,V:()=>s});const s="https://iapkit.com",r="https://www.hyo.dev/api/ad-banner/cmjf0l20n0002249hjrwmgob3"},8453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>a});var s=i(6540);const r={},t=s.createContext(r);function c(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:n},e.children)}},9712:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var s=i(4848),r=i(8453),t=i(5159),c=i(1437);const a={sidebar_position:2,title:"Subscription Flow"},o="Subscription Flow",l={id:"examples/subscription-flow",title:"Subscription Flow",description:"Key Concepts",source:"@site/docs/examples/subscription-flow.md",sourceDirName:"examples",slug:"/examples/subscription-flow",permalink:"/kmp-iap/docs/examples/subscription-flow",draft:!1,unlisted:!1,editUrl:"https://github.com/hyochan/kmp-iap/tree/main/docs/docs/examples/subscription-flow.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Subscription Flow"},sidebar:"docsSidebar",previous:{title:"Purchase Flow",permalink:"/kmp-iap/docs/examples/purchase-flow"},next:{title:"Complete Implementation",permalink:"/kmp-iap/docs/examples/complete-implementation"}},d={},p=[{value:"Key Concepts",id:"key-concepts",level:2},{value:"Fetch Subscriptions",id:"fetch-subscriptions",level:2},{value:"Check Active Subscriptions",id:"check-active-subscriptions",level:2},{value:"Access Subscription Offers (v1.3.12+)",id:"access-subscription-offers-v1312",level:2},{value:"Offer Types",id:"offer-types",level:3},{value:"Payment Modes",id:"payment-modes",level:3},{value:"Request Subscription",id:"request-subscription",level:2},{value:"Finish Transaction",id:"finish-transaction",level:2},{value:"Platform-Specific Info",id:"platform-specific-info",level:2},{value:"Android Subscription Management",id:"android-subscription-management",level:2},{value:"IAPKit Server Verification",id:"iapkit-server-verification",level:2},{value:"Setup",id:"setup",level:3},{value:"Subscription Verification",id:"subscription-verification",level:3},{value:"Verification Response",id:"verification-response",level:3},{value:"Periodic Validation",id:"periodic-validation",level:3},{value:"IAPKit Subscription States",id:"iapkit-subscription-states",level:2},{value:"Checking Subscription Status on App Launch",id:"checking-subscription-status-on-app-launch",level:2},{value:"Complete Verification Flow",id:"complete-verification-flow",level:2},{value:"Android basePlanId Limitation",id:"baseplanid-limitation",level:2},{value:"Client-Side Limitation",id:"client-side-limitation",level:3},{value:"Solution: Server-Side Verification with IAPKit",id:"solution-server-side-verification-with-iapkit",level:3},{value:"Next Steps",id:"next-steps",level:2}];function h(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"subscription-flow",children:"Subscription Flow"}),"\n",(0,s.jsx)(t.A,{}),"\n",(0,s.jsx)(n.h2,{id:"key-concepts",children:"Key Concepts"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"ProductQueryType.Subs"})," to fetch subscription products"]}),"\n",(0,s.jsxs)(n.li,{children:["Android requires ",(0,s.jsx)(n.code,{children:"offerToken"})," for subscription purchases"]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"getActiveSubscriptions()"})," to check subscription status"]}),"\n",(0,s.jsxs)(n.li,{children:["Always set ",(0,s.jsx)(n.code,{children:"isConsumable = false"})," when finishing subscription transactions"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"fetch-subscriptions",children:"Fetch Subscriptions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'val subscriptions = kmpIapInstance.fetchProducts {\n    skus = listOf("premium_monthly", "premium_yearly")\n    type = ProductQueryType.Subs\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"check-active-subscriptions",children:"Check Active Subscriptions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'// Quick check\nval hasActive = kmpIapInstance.hasActiveSubscriptions(subscriptionIds)\n\n// Detailed info\nval activeSubscriptions = kmpIapInstance.getActiveSubscriptions(subscriptionIds)\nactiveSubscriptions.forEach { sub ->\n    println("Product: ${sub.productId}")\n    println("Expires: ${sub.expirationDateIOS}")      // iOS\n    println("Auto-renewing: ${sub.autoRenewingAndroid}") // Android\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"access-subscription-offers-v1312",children:"Access Subscription Offers (v1.3.12+)"}),"\n",(0,s.jsxs)(n.p,{children:["Starting from v1.3.12, subscription products include a cross-platform ",(0,s.jsx)(n.code,{children:"subscriptionOffers"})," field that provides unified access to introductory and promotional offers:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'val subscriptions = kmpIapInstance.fetchProducts {\n    skus = listOf("premium_monthly", "premium_yearly")\n    type = ProductQueryType.Subs\n}\n\nsubscriptions.forEach { product ->\n    when (product) {\n        is ProductSubscriptionAndroid -> {\n            // Android subscriptionOffers is a non-null list\n            product.subscriptionOffers.forEach { offer ->\n                println("Offer ID: ${offer.id}")\n                println("Price: ${offer.displayPrice}")\n                println("Type: ${offer.type}")  // Introductory, Promotional\n                println("Payment Mode: ${offer.paymentMode}")  // FreeTrial, PayAsYouGo, PayUpFront\n\n                // Android-specific fields\n                println("Base Plan: ${offer.basePlanIdAndroid}")\n                println("Token: ${offer.offerTokenAndroid}")\n            }\n        }\n        is ProductSubscriptionIOS -> {\n            // iOS subscriptionOffers is nullable\n            product.subscriptionOffers?.forEach { offer ->\n                println("Offer ID: ${offer.id}")\n                println("Price: ${offer.displayPrice}")\n                println("Type: ${offer.type}")\n                println("Payment Mode: ${offer.paymentMode}")\n\n                // iOS-specific fields\n                offer.period?.let { period ->\n                    println("Period: ${period.value} ${period.unit}")\n                }\n            }\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"offer-types",children:"Offer Types"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Introductory"})}),(0,s.jsx)(n.td,{children:"First-time subscriber discount (free trial, reduced price)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Promotional"})}),(0,s.jsx)(n.td,{children:"Winback or promotional offer for existing/lapsed subscribers"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OneTime"})}),(0,s.jsx)(n.td,{children:"One-time purchase discount (Android only)"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"payment-modes",children:"Payment Modes"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Mode"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FreeTrial"})}),(0,s.jsx)(n.td,{children:"Free for a limited period"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PayAsYouGo"})}),(0,s.jsx)(n.td,{children:"Reduced price for each billing cycle"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PayUpFront"})}),(0,s.jsx)(n.td,{children:"Pay reduced price upfront for entire period"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"request-subscription",children:"Request Subscription"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'// Get offer token for Android\nval product = subscriptions.find { it.productId == "premium_monthly" }\nval offerToken = when (product) {\n    is ProductSubscriptionAndroid -> product.subscriptionOffers.firstOrNull()?.offerTokenAndroid\n    else -> null\n}\n\nkmpIapInstance.requestPurchase {\n    apple { sku = "premium_monthly" }\n    google {  // Recommended (v1.3.15+)\n        skus = listOf("premium_monthly")\n        subscriptionOffers = offerToken?.let {\n            listOf(AndroidSubscriptionOfferInput(sku = "premium_monthly", offerToken = it))\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"finish-transaction",children:"Finish Transaction"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"kmpIapInstance.finishTransaction(\n    purchase = purchase.toPurchaseInput(),\n    isConsumable = false  // Subscriptions are never consumable\n)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"platform-specific-info",children:"Platform-Specific Info"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Feature"}),(0,s.jsx)(n.th,{children:"iOS"}),(0,s.jsx)(n.th,{children:"Android"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Expiration"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"expirationDateIOS"})}),(0,s.jsx)(n.td,{children:"Server-side"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Environment"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"environmentIOS"})}),(0,s.jsx)(n.td,{children:"N/A"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Auto-renew"}),(0,s.jsx)(n.td,{children:"N/A"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"autoRenewingAndroid"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Manage subs"}),(0,s.jsx)(n.td,{children:"App Store"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"deepLinkToSubscriptions()"})})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"android-subscription-management",children:"Android Subscription Management"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'if (getCurrentPlatform() == IapPlatform.Android) {\n    kmpIapInstance.deepLinkToSubscriptions(\n        DeepLinkOptions(skuAndroid = "premium_monthly")\n    )\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"iapkit-server-verification",children:"IAPKit Server Verification"}),"\n",(0,s.jsx)(n.p,{children:"For subscription apps, server-side verification is critical for managing access control and handling renewals."}),"\n",(0,s.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Get your API key from ",(0,s.jsx)(c.A,{children:"iapkit.com"})]}),"\n",(0,s.jsxs)(n.li,{children:["Configure environment variables (see ",(0,s.jsx)(n.a,{href:"/kmp-iap/docs/examples/purchase-flow#setup",children:"Purchase Flow"})," for details)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"subscription-verification",children:"Subscription Verification"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'kmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n    val purchaseToken = purchase.purchaseToken\n    if (purchaseToken.isNullOrEmpty()) {\n        showError("No purchase token available")\n        return@collect\n    }\n\n    try {\n        val result = kmpIapInstance.verifyPurchaseWithProvider(\n            VerifyPurchaseWithProviderProps(\n                provider = PurchaseVerificationProvider.Iapkit,\n                iapkit = RequestVerifyPurchaseWithIapkitProps(\n                    apiKey = AppConfig.iapkitApiKey,\n                    apple = RequestVerifyPurchaseWithIapkitAppleProps(jws = purchaseToken),\n                    google = RequestVerifyPurchaseWithIapkitGoogleProps(purchaseToken = purchaseToken)\n                )\n            )\n        )\n\n        when (result.iapkit?.state) {\n            IapkitPurchaseState.Entitled -> {\n                // Active subscription - grant access\n                grantSubscriptionAccess(purchase.productId)\n                kmpIapInstance.finishTransaction(\n                    purchase = purchase.toPurchaseInput(),\n                    isConsumable = false\n                )\n            }\n            IapkitPurchaseState.Expired -> {\n                // Subscription ended - revoke access\n                revokeSubscriptionAccess(purchase.productId)\n            }\n            IapkitPurchaseState.Canceled -> {\n                // User canceled but may still have access until period ends\n                showInfo("Subscription will end at period end")\n            }\n            IapkitPurchaseState.Inauthentic -> {\n                // Fraudulent purchase detected\n                revokeSubscriptionAccess(purchase.productId)\n                showError("Invalid purchase detected")\n            }\n            else -> {\n                showError("Unknown state: ${result.iapkit?.state}")\n            }\n        }\n    } catch (e: Exception) {\n        showError("Verification error: ${e.message}")\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"verification-response",children:"Verification Response"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "isValid": true,\n  "state": "ENTITLED",\n  "store": "APPLE"\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"// Access in code\nval isValid = result.iapkit?.isValid     // true\nval state = result.iapkit?.state         // IapkitPurchaseState.Entitled\nval store = result.iapkit?.store         // IapStore.Apple or IapStore.Google\n"})}),"\n",(0,s.jsx)(n.h3,{id:"periodic-validation",children:"Periodic Validation"}),"\n",(0,s.jsx)(n.p,{children:"For production apps, validate subscriptions periodically:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:"// On app launch or every 24 hours\nsuspend fun validateActiveSubscriptions() {\n    val activeSubscriptions = kmpIapInstance.getActiveSubscriptions(subscriptionIds)\n\n    activeSubscriptions.forEach { subscription ->\n        val result = verifyWithIapkit(subscription)\n\n        when (result.iapkit?.state) {\n            IapkitPurchaseState.Entitled -> { /* Still valid */ }\n            IapkitPurchaseState.Expired,\n            IapkitPurchaseState.Canceled -> {\n                revokeSubscriptionAccess(subscription.productId)\n            }\n            else -> { /* Handle error */ }\n        }\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"iapkit-subscription-states",children:"IAPKit Subscription States"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"State"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"entitled"})}),(0,s.jsx)(n.td,{children:"User has an active, valid subscription"}),(0,s.jsx)(n.td,{children:"Grant access"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"expired"})}),(0,s.jsx)(n.td,{children:"Subscription has expired and not renewed"}),(0,s.jsx)(n.td,{children:"Remove access"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"canceled"})}),(0,s.jsx)(n.td,{children:"User cancelled but may still have access until period ends"}),(0,s.jsx)(n.td,{children:"Check expiration date"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"pending"})}),(0,s.jsx)(n.td,{children:"Payment is pending (e.g., awaiting parental approval)"}),(0,s.jsx)(n.td,{children:"Show pending UI"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"pending-acknowledgment"})}),(0,s.jsx)(n.td,{children:"Purchase needs acknowledgment (Android)"}),(0,s.jsxs)(n.td,{children:["Call ",(0,s.jsx)(n.code,{children:"finishTransaction()"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"inauthentic"})}),(0,s.jsx)(n.td,{children:"Purchase could not be verified / fraudulent"}),(0,s.jsx)(n.td,{children:"Deny access"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"checking-subscription-status-on-app-launch",children:"Checking Subscription Status on App Launch"}),"\n",(0,s.jsx)(n.admonition,{title:"Android Renewal Detection",type:"warning",children:(0,s.jsxs)(n.p,{children:["On Android, ",(0,s.jsx)(n.code,{children:"purchaseUpdatedListener"})," does ",(0,s.jsx)(n.strong,{children:"not"})," fire for renewals that occurred while the app was closed. Always verify subscription status on app launch."]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'class SubscriptionViewModel : ViewModel() {\n    private val subscriptionIds = listOf("premium_monthly", "premium_yearly")\n\n    init {\n        viewModelScope.launch {\n            kmpIapInstance.initConnection()\n            checkSubscriptionStatusOnLaunch()\n        }\n    }\n\n    private suspend fun checkSubscriptionStatusOnLaunch() {\n        try {\n            val purchases = kmpIapInstance.getAvailablePurchases()\n\n            val subscriptionPurchase = purchases.find {\n                subscriptionIds.contains(it.productId)\n            }\n\n            if (subscriptionPurchase == null) {\n                // No subscription found\n                updateUIForExpiredSubscription()\n                return\n            }\n\n            // Verify with IAPKit for authoritative status\n            val result = kmpIapInstance.verifyPurchaseWithProvider(\n                VerifyPurchaseWithProviderProps(\n                    provider = PurchaseVerificationProvider.Iapkit,\n                    iapkit = RequestVerifyPurchaseWithIapkitProps(\n                        apiKey = AppConfig.iapkitApiKey,\n                        apple = RequestVerifyPurchaseWithIapkitAppleProps(\n                            jws = subscriptionPurchase.purchaseToken\n                        ),\n                        google = RequestVerifyPurchaseWithIapkitGoogleProps(\n                            purchaseToken = subscriptionPurchase.purchaseToken\n                        )\n                    )\n                )\n            )\n\n            when (result.iapkit?.state) {\n                IapkitPurchaseState.Entitled -> {\n                    grantSubscriptionAccess(subscriptionPurchase.productId)\n                }\n                IapkitPurchaseState.Expired -> {\n                    revokeSubscriptionAccess(subscriptionPurchase.productId)\n                    showRenewalPrompt()\n                }\n                IapkitPurchaseState.Canceled -> {\n                    // Still has access until period ends\n                    showCancellationNotice()\n                }\n                else -> {\n                    handleUnknownState(result.iapkit?.state)\n                }\n            }\n        } catch (e: Exception) {\n            // Grant temporary access on error to avoid penalizing users\n            grantTemporaryAccess()\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"complete-verification-flow",children:"Complete Verification Flow"}),"\n",(0,s.jsxs)(n.p,{children:["Here's a complete example of handling subscription verification within ",(0,s.jsx)(n.code,{children:"purchaseUpdatedListener"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'private suspend fun onPurchaseSuccess(purchase: Purchase) {\n    val purchaseToken = purchase.purchaseToken\n    if (purchaseToken.isNullOrEmpty()) {\n        showError("No purchase token available")\n        return\n    }\n\n    try {\n        val result = kmpIapInstance.verifyPurchaseWithProvider(\n            VerifyPurchaseWithProviderProps(\n                provider = PurchaseVerificationProvider.Iapkit,\n                iapkit = RequestVerifyPurchaseWithIapkitProps(\n                    apiKey = AppConfig.iapkitApiKey,\n                    apple = RequestVerifyPurchaseWithIapkitAppleProps(jws = purchaseToken),\n                    google = RequestVerifyPurchaseWithIapkitGoogleProps(purchaseToken = purchaseToken)\n                )\n            )\n        )\n\n        when (result.iapkit?.state) {\n            IapkitPurchaseState.Entitled -> {\n                // 1. Grant access\n                grantSubscriptionAccess(purchase.productId)\n\n                // 2. Finish the transaction\n                kmpIapInstance.finishTransaction(\n                    purchase = purchase.toPurchaseInput(),\n                    isConsumable = false\n                )\n\n                // 3. Show success message\n                showSuccess("Subscription activated!")\n            }\n\n            IapkitPurchaseState.PendingAcknowledgment -> {\n                // Android: Transaction needs acknowledgment\n                kmpIapInstance.finishTransaction(\n                    purchase = purchase.toPurchaseInput(),\n                    isConsumable = false\n                )\n                grantSubscriptionAccess(purchase.productId)\n            }\n\n            IapkitPurchaseState.Pending -> {\n                // Purchase still processing (e.g., pending payment)\n                showPendingUI(purchase.productId)\n            }\n\n            IapkitPurchaseState.Expired,\n            IapkitPurchaseState.Canceled -> {\n                revokeSubscriptionAccess(purchase.productId)\n            }\n\n            IapkitPurchaseState.Inauthentic -> {\n                revokeSubscriptionAccess(purchase.productId)\n                logSecurityEvent("Inauthentic purchase detected", purchase)\n            }\n\n            else -> {\n                showError("Unexpected state: ${result.iapkit?.state}")\n            }\n        }\n    } catch (e: Exception) {\n        // Handle verification errors gracefully\n        // Consider granting temporary access rather than blocking the user\n        showError("Verification error: ${e.message}")\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["For more details on subscription validation patterns, see ",(0,s.jsx)(n.a,{href:"/kmp-iap/docs/guides/subscription-validation",children:"Subscription Validation"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"baseplanid-limitation",children:"Android basePlanId Limitation"}),"\n",(0,s.jsx)(n.h3,{id:"client-side-limitation",children:"Client-Side Limitation"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"basePlanId"})," is available when fetching products, but ",(0,s.jsx)(n.strong,{children:"not"})," when retrieving purchases via ",(0,s.jsx)(n.code,{children:"getAvailablePurchases()"}),". This is a limitation of Google Play Billing Library - the purchase token alone doesn't reveal which base plan was purchased."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"https://github.com/hyochan/react-native-iap/issues/3096",children:"GitHub Issue #3096"})," for more details."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Why this matters:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If you have multiple base plans (e.g., monthly, yearly, premium), you cannot determine which plan the user is subscribed to using client-side APIs alone"}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"basePlanId"})," is only available from ",(0,s.jsx)(n.code,{children:"subscriptionOfferDetailsAndroid"})," at the time of purchase, not from restored purchases"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"solution-server-side-verification-with-iapkit",children:"Solution: Server-Side Verification with IAPKit"}),"\n",(0,s.jsxs)(n.p,{children:["Use the ",(0,s.jsx)(n.code,{children:"verifyPurchaseWithProvider"})," function to get complete subscription details including ",(0,s.jsx)(n.code,{children:"basePlanId"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'val verifyAndroidSubscription = suspend fun(purchase: Purchase) {\n    val result = kmpIapInstance.verifyPurchaseWithProvider(\n        VerifyPurchaseWithProviderProps(\n            provider = PurchaseVerificationProvider.Iapkit,\n            iapkit = RequestVerifyPurchaseWithIapkitProps(\n                apiKey = AppConfig.iapkitApiKey,\n                google = RequestVerifyPurchaseWithIapkitGoogleProps(\n                    purchaseToken = purchase.purchaseToken\n                )\n            )\n        )\n    )\n\n    // Response includes offerDetails.basePlanId in lineItems\n    val basePlanId = result.providerResponse\n        ?.get("lineItems")\n        ?.let { (it as? List<*>)?.firstOrNull() as? Map<*, *> }\n        ?.get("offerDetails")\n        ?.let { (it as? Map<*, *>)?.get("basePlanId") as? String }\n\n    println("Subscribed to base plan: $basePlanId")\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"https://www.openiap.dev/docs/apis#verifypurchasewithprovider",children:"verifyPurchaseWithProvider"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The server response includes ",(0,s.jsx)(n.code,{children:"offerDetails.basePlanId"})," in the ",(0,s.jsx)(n.code,{children:"lineItems"})," array, allowing you to identify exactly which subscription plan the user purchased."]}),"\n",(0,s.jsx)(n.admonition,{title:"Subscription Offers",type:"tip",children:(0,s.jsxs)(n.p,{children:["When fetching products, each subscription offer includes: ",(0,s.jsx)(n.code,{children:"basePlanId"}),", ",(0,s.jsx)(n.code,{children:"offerId?"}),", ",(0,s.jsx)(n.code,{children:"offerTags"}),", ",(0,s.jsx)(n.code,{children:"offerToken"}),", and ",(0,s.jsx)(n.code,{children:"pricingPhases"}),". See ",(0,s.jsx)(n.a,{href:"https://www.openiap.dev/docs/types#productsubscriptionandroidofferdetails",children:"ProductSubscriptionAndroidOfferDetails"})," for more details."]})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(c.A,{children:"IAPKit documentation"})," for setup instructions and API details."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/kmp-iap/docs/examples/purchase-flow",children:"Purchase Flow"})," - One-time purchases"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/kmp-iap/docs/api/error-codes",children:"Error Codes"})," - Handle all error types"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);