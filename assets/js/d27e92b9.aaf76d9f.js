"use strict";(self.webpackChunkkmp_iap_docs=self.webpackChunkkmp_iap_docs||[]).push([[363],{533:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var r=i(4848),l=i(8453),t=i(5159);const a={title:"Alternative Billing Example",sidebar_label:"Alternative Billing",sidebar_position:4},o="Alternative Billing",s={id:"examples/alternative-billing",title:"Alternative Billing Example",description:"Use alternative billing to redirect users to external payment systems or offer payment choices alongside platform billing.",source:"@site/docs/examples/alternative-billing.md",sourceDirName:"examples",slug:"/examples/alternative-billing",permalink:"/kmp-iap/docs/examples/alternative-billing",draft:!1,unlisted:!1,editUrl:"https://github.com/hyochan/kmp-iap/tree/main/docs/docs/examples/alternative-billing.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Alternative Billing Example",sidebar_label:"Alternative Billing",sidebar_position:4},sidebar:"docsSidebar",previous:{title:"Complete Implementation",permalink:"/kmp-iap/docs/examples/complete-implementation"},next:{title:"AI Assistants",permalink:"/kmp-iap/docs/guides/ai-assistants"}},d={},c=[{value:"iOS - External Purchase URL",id:"ios---external-purchase-url",level:2},{value:"Important Notes",id:"important-notes",level:3},{value:"Android - Billing Programs",id:"android---billing-programs",level:2},{value:"Billing Program Options",id:"billing-program-options",level:3},{value:"Event Listeners by Program",id:"event-listeners-by-program",level:3},{value:"Complete Cross-Platform Example",id:"complete-cross-platform-example",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Initialize with Billing Program (v1.3.0+)",id:"initialize-with-billing-program-v130",level:3},{value:"iOS Configuration (Info.plist)",id:"ios-configuration-infoplist",level:3},{value:"iOS Entitlements",id:"ios-entitlements",level:3},{value:"Event Listeners",id:"event-listeners",level:2},{value:"Purchase Updates (Google Play)",id:"purchase-updates-google-play",level:3},{value:"User Choice Billing (Android)",id:"user-choice-billing-android",level:3},{value:"Purchase Errors",id:"purchase-errors",level:3},{value:"Testing",id:"testing",level:2},{value:"iOS",id:"ios",level:3},{value:"Android",id:"android",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Check if Alternative Billing is Available",id:"check-if-alternative-billing-is-available",level:3},{value:"Handle Alternative Billing Purchase Result",id:"handle-alternative-billing-purchase-result",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"iOS: External URL not opening",id:"ios-external-url-not-opening",level:3},{value:"Android: Alternative billing not available",id:"android-alternative-billing-not-available",level:3},{value:"Android: Token creation failed",id:"android-token-creation-failed",level:3},{value:"See Also",id:"see-also",level:2}];function p(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{id:"alternative-billing",children:"Alternative Billing"}),"\n",(0,r.jsx)(t.A,{}),"\n",(0,r.jsx)(e.p,{children:"Use alternative billing to redirect users to external payment systems or offer payment choices alongside platform billing."}),"\n",(0,r.jsx)(e.p,{children:"View the full example source:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["GitHub: ",(0,r.jsx)(e.a,{href:"https://github.com/hyochan/kmp-iap/blob/main/example/composeApp/src/commonMain/kotlin/dev/hyo/martie/screens/AlternativeBillingScreen.kt",children:"AlternativeBillingScreen.kt"})]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"ios---external-purchase-url",children:"iOS - External Purchase URL"}),"\n",(0,r.jsx)(e.p,{children:"Redirect users to an external website for payment (iOS 16.0+):"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'import io.github.hyochan.kmpiap.kmpIapInstance\nimport io.github.hyochan.kmpiap.openiap.ProductCommon\nimport androidx.compose.material3.Button\nimport androidx.compose.material3.Text\nimport androidx.compose.runtime.Composable\nimport androidx.compose.runtime.rememberCoroutineScope\nimport kotlinx.coroutines.launch\n\n@Composable\nfun IOSAlternativeBilling(product: ProductCommon) {\n    val scope = rememberCoroutineScope()\n\n    Button(\n        onClick = {\n            scope.launch {\n                try {\n                    val result = kmpIapInstance.presentExternalPurchaseLinkIOS(\n                        url = "https://your-site.com/checkout?product=${product.id}"\n                    )\n\n                    if (result.success) {\n                        // User was redirected to external website\n                        println("Redirected to external checkout")\n                    } else {\n                        println("Error: ${result.error}")\n                    }\n                } catch (e: Exception) {\n                    println("Failed to present external link: ${e.message}")\n                }\n            }\n        }\n    ) {\n        Text("Buy (External URL)")\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"important-notes",children:"Important Notes"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"iOS 16.0+ Required"}),": External URLs only work on iOS 16.0 and later"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Configuration Required"}),": External URLs must be configured in Info.plist (see ",(0,r.jsx)(e.a,{href:"/kmp-iap/docs/guides/alternative-billing",children:"Alternative Billing Guide"}),")"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"No Callback"}),": ",(0,r.jsx)(e.code,{children:"purchaseUpdatedListener"})," will NOT fire when using external URLs"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Deep Linking"}),": Implement deep linking to return users to your app"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"android---billing-programs",children:"Android - Billing Programs"}),"\n",(0,r.jsx)(e.p,{children:"Select a billing program and handle purchases accordingly (v1.3.0+):"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'import io.github.hyochan.kmpiap.kmpIapInstance\nimport io.github.hyochan.kmpiap.requestPurchase\nimport io.github.hyochan.kmpiap.openiap.*\nimport androidx.compose.foundation.clickable\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport kotlinx.coroutines.launch\nimport kotlinx.coroutines.flow.collect\n\n@Composable\nfun AndroidBillingPrograms(product: ProductCommon) {\n    val scope = rememberCoroutineScope()\n    var billingProgram by remember { mutableStateOf(BillingProgramAndroid.ExternalOffer) }\n    var showProgramSelector by remember { mutableStateOf(false) }\n    var connected by remember { mutableStateOf(false) }\n\n    // Initialize with selected billing program\n    LaunchedEffect(billingProgram) {\n        val config = InitConnectionConfig(\n            enableBillingProgramAndroid = billingProgram\n        )\n        connected = kmpIapInstance.initConnection(config)\n    }\n\n    // Listen for purchase events\n    LaunchedEffect(Unit) {\n        // Google Play purchases (UserChoiceBilling, ExternalPayments)\n        launch {\n            kmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n                println("Google Play purchase: ${purchase.productId}")\n            }\n        }\n\n        // User choice events (UserChoiceBilling)\n        launch {\n            kmpIapInstance.userChoiceBillingListener.collect { details ->\n                println("User selected alternative billing: ${details.products}")\n            }\n        }\n\n        // Developer provided billing (ExternalPayments - Japan only)\n        launch {\n            kmpIapInstance.developerProvidedBillingListener.collect { details ->\n                println("Developer billing selected: ${details.externalTransactionToken}")\n            }\n        }\n    }\n\n    Column {\n        // Billing Program Selector (Dropdown)\n        Text("Billing Program:", style = MaterialTheme.typography.titleMedium)\n        Spacer(modifier = Modifier.height(8.dp))\n\n        Card(\n            modifier = Modifier\n                .fillMaxWidth()\n                .clickable { showProgramSelector = true }\n        ) {\n            Row(\n                modifier = Modifier.padding(16.dp).fillMaxWidth(),\n                horizontalArrangement = Arrangement.SpaceBetween\n            ) {\n                Text(\n                    text = when (billingProgram) {\n                        BillingProgramAndroid.ExternalOffer -> "External Offer (8.2.0+)"\n                        BillingProgramAndroid.UserChoiceBilling -> "User Choice Billing (7.0+)"\n                        BillingProgramAndroid.ExternalPayments -> "External Payments (8.3.0+, Japan)"\n                        else -> "Select Program"\n                    }\n                )\n                Text("\u25bc", color = MaterialTheme.colorScheme.onSurfaceVariant)\n            }\n        }\n\n        // Program Selector Dialog\n        if (showProgramSelector) {\n            AlertDialog(\n                onDismissRequest = { showProgramSelector = false },\n                title = { Text("Select Billing Program") },\n                text = {\n                    Column {\n                        // Option 1: External Offer\n                        Card(\n                            modifier = Modifier\n                                .fillMaxWidth()\n                                .clickable {\n                                    billingProgram = BillingProgramAndroid.ExternalOffer\n                                    showProgramSelector = false\n                                }\n                        ) {\n                            Column(modifier = Modifier.padding(12.dp)) {\n                                Text(\n                                    "External Offer (8.2.0+)",\n                                    style = MaterialTheme.typography.titleSmall\n                                )\n                                Text(\n                                    "Only your payment system. Manual 3-step flow required.",\n                                    style = MaterialTheme.typography.bodySmall\n                                )\n                            }\n                        }\n\n                        Spacer(modifier = Modifier.height(8.dp))\n\n                        // Option 2: User Choice Billing\n                        Card(\n                            modifier = Modifier\n                                .fillMaxWidth()\n                                .clickable {\n                                    billingProgram = BillingProgramAndroid.UserChoiceBilling\n                                    showProgramSelector = false\n                                }\n                        ) {\n                            Column(modifier = Modifier.padding(12.dp)) {\n                                Text(\n                                    "User Choice Billing (7.0+)",\n                                    style = MaterialTheme.typography.titleSmall\n                                )\n                                Text(\n                                    "Users choose between Google Play or your payment system.",\n                                    style = MaterialTheme.typography.bodySmall\n                                )\n                            }\n                        }\n\n                        Spacer(modifier = Modifier.height(8.dp))\n\n                        // Option 3: External Payments\n                        Card(\n                            modifier = Modifier\n                                .fillMaxWidth()\n                                .clickable {\n                                    billingProgram = BillingProgramAndroid.ExternalPayments\n                                    showProgramSelector = false\n                                }\n                        ) {\n                            Column(modifier = Modifier.padding(12.dp)) {\n                                Text(\n                                    "External Payments (8.3.0+, Japan)",\n                                    style = MaterialTheme.typography.titleSmall\n                                )\n                                Text(\n                                    "Side-by-side choice in purchase dialog. Japan users only.",\n                                    style = MaterialTheme.typography.bodySmall\n                                )\n                            }\n                        }\n                    }\n                },\n                confirmButton = {\n                    TextButton(onClick = { showProgramSelector = false }) {\n                        Text("Cancel")\n                    }\n                }\n            )\n        }\n\n        Spacer(modifier = Modifier.height(16.dp))\n\n        // Purchase button\n        Button(\n            onClick = {\n                scope.launch {\n                    when (billingProgram) {\n                        BillingProgramAndroid.ExternalOffer -> {\n                            // Manual 3-step flow\n                            val isAvailable = kmpIapInstance.checkAlternativeBillingAvailabilityAndroid()\n                            if (!isAvailable) return@launch\n\n                            val userAccepted = kmpIapInstance.showAlternativeBillingDialogAndroid()\n                            if (!userAccepted) return@launch\n\n                            // Process payment with your system...\n                            val token = kmpIapInstance.createAlternativeBillingTokenAndroid()\n                            println("Token: $token")\n                        }\n                        BillingProgramAndroid.UserChoiceBilling -> {\n                            // Google shows selection dialog\n                            kmpIapInstance.requestPurchase {\n                                google { skus = listOf(product.id) }\n                            }\n                        }\n                        BillingProgramAndroid.ExternalPayments -> {\n                            // Japan: Side-by-side choice in dialog\n                            kmpIapInstance.requestPurchase {\n                                google {\n                                    skus = listOf(product.id)\n                                    developerBillingOption = DeveloperBillingOptionParamsAndroid(\n                                        billingProgram = BillingProgramAndroid.ExternalPayments,\n                                        launchMode = DeveloperBillingLaunchModeAndroid.LaunchInExternalBrowserOrApp,\n                                        linkUri = "https://your-site.com/checkout"\n                                    )\n                                }\n                            }\n                        }\n                        else -> println("Select a billing program")\n                    }\n                }\n            },\n            enabled = connected\n        ) {\n            Text(\n                when (billingProgram) {\n                    BillingProgramAndroid.ExternalOffer -> "Buy (External Offer)"\n                    BillingProgramAndroid.UserChoiceBilling -> "Buy (User Choice)"\n                    BillingProgramAndroid.ExternalPayments -> "Buy (External Payments)"\n                    else -> "Buy"\n                }\n            )\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"billing-program-options",children:"Billing Program Options"}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Program"}),(0,r.jsx)(e.th,{children:"Min Version"}),(0,r.jsx)(e.th,{children:"Description"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"ExternalOffer"})}),(0,r.jsx)(e.td,{children:"8.2.0+"}),(0,r.jsx)(e.td,{children:"Only your payment system. Manual 3-step flow required."})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"UserChoiceBilling"})}),(0,r.jsx)(e.td,{children:"7.0+"}),(0,r.jsx)(e.td,{children:"Users choose between Google Play or your payment system via dialog."})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"ExternalPayments"})}),(0,r.jsx)(e.td,{children:"8.3.0+"}),(0,r.jsx)(e.td,{children:"Side-by-side choice in purchase dialog. Japan users only."})]})]})]}),"\n",(0,r.jsx)(e.h3,{id:"event-listeners-by-program",children:"Event Listeners by Program"}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Program"}),(0,r.jsx)(e.th,{children:(0,r.jsx)(e.code,{children:"purchaseUpdatedListener"})}),(0,r.jsx)(e.th,{children:(0,r.jsx)(e.code,{children:"userChoiceBillingListener"})}),(0,r.jsx)(e.th,{children:(0,r.jsx)(e.code,{children:"developerProvidedBillingListener"})})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"ExternalOffer"})}),(0,r.jsx)(e.td,{children:"\u274c"}),(0,r.jsx)(e.td,{children:"\u274c"}),(0,r.jsx)(e.td,{children:"\u274c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"UserChoiceBilling"})}),(0,r.jsx)(e.td,{children:"\u2705 (Google Play)"}),(0,r.jsx)(e.td,{children:"\u2705 (Alternative)"}),(0,r.jsx)(e.td,{children:"\u274c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"ExternalPayments"})}),(0,r.jsx)(e.td,{children:"\u2705 (Google Play)"}),(0,r.jsx)(e.td,{children:"\u274c"}),(0,r.jsx)(e.td,{children:"\u2705 (Developer billing)"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"complete-cross-platform-example",children:"Complete Cross-Platform Example"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'import androidx.compose.foundation.clickable\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport io.github.hyochan.kmpiap.kmpIapInstance\nimport io.github.hyochan.kmpiap.requestPurchase\nimport io.github.hyochan.kmpiap.fetchProducts\nimport io.github.hyochan.kmpiap.openiap.*\nimport kotlinx.coroutines.launch\n\n@Composable\nfun AlternativeBillingScreen() {\n    val scope = rememberCoroutineScope()\n    var billingProgram by remember { mutableStateOf(BillingProgramAndroid.ExternalOffer) }\n    var showProgramSelector by remember { mutableStateOf(false) }\n    var products by remember { mutableStateOf<List<ProductCommon>>(emptyList()) }\n    var connected by remember { mutableStateOf(false) }\n    var externalUrl by remember { mutableStateOf("https://your-site.com") }\n\n    // Initialize connection (v1.3.0+)\n    LaunchedEffect(billingProgram) {\n        val config = if (getPlatformName() == "Android") {\n            InitConnectionConfig(enableBillingProgramAndroid = billingProgram)\n        } else null\n\n        connected = kmpIapInstance.initConnection(config)\n\n        if (connected) {\n            products = kmpIapInstance.fetchProducts {\n                skus = listOf("premium_upgrade", "coins_100")\n                type = ProductQueryType.InApp\n            }\n        }\n    }\n\n    // Listen for purchase events\n    LaunchedEffect(Unit) {\n        launch {\n            kmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n                println("Purchase successful: ${purchase.productId}")\n            }\n        }\n\n        launch {\n            kmpIapInstance.purchaseErrorListener.collect { error ->\n                println("Purchase error: ${error.message}")\n            }\n        }\n\n        // Android listeners\n        if (getPlatformName() == "Android") {\n            launch {\n                kmpIapInstance.userChoiceBillingListener.collect { details ->\n                    println("User chose alternative billing: ${details.products}")\n                }\n            }\n            launch {\n                kmpIapInstance.developerProvidedBillingListener.collect { details ->\n                    println("Developer billing: ${details.externalTransactionToken}")\n                }\n            }\n        }\n    }\n\n    // Platform-specific purchase handlers\n    fun handleIOSPurchase(product: ProductCommon) {\n        scope.launch {\n            val result = kmpIapInstance.presentExternalPurchaseLinkIOS(\n                url = "$externalUrl?product=${product.id}"\n            )\n            if (result.success) {\n                println("Redirected to external checkout")\n            } else {\n                println("Error: ${result.error}")\n            }\n        }\n    }\n\n    fun handleAndroidPurchase(product: ProductCommon) {\n        scope.launch {\n            when (billingProgram) {\n                BillingProgramAndroid.ExternalOffer -> {\n                    val isAvailable = kmpIapInstance.checkAlternativeBillingAvailabilityAndroid()\n                    if (!isAvailable) return@launch\n\n                    val userAccepted = kmpIapInstance.showAlternativeBillingDialogAndroid()\n                    if (!userAccepted) return@launch\n\n                    val token = kmpIapInstance.createAlternativeBillingTokenAndroid()\n                    println("Token: $token")\n                }\n                BillingProgramAndroid.UserChoiceBilling -> {\n                    kmpIapInstance.requestPurchase {\n                        google { skus = listOf(product.id) }\n                    }\n                }\n                BillingProgramAndroid.ExternalPayments -> {\n                    kmpIapInstance.requestPurchase {\n                        google {\n                            skus = listOf(product.id)\n                            developerBillingOption = DeveloperBillingOptionParamsAndroid(\n                                billingProgram = BillingProgramAndroid.ExternalPayments,\n                                launchMode = DeveloperBillingLaunchModeAndroid.LaunchInExternalBrowserOrApp,\n                                linkUri = externalUrl\n                            )\n                        }\n                    }\n                }\n                else -> println("Select a billing program")\n            }\n        }\n    }\n\n    fun handlePurchase(product: ProductCommon) {\n        when (getPlatformName()) {\n            "iOS" -> handleIOSPurchase(product)\n            "Android" -> handleAndroidPurchase(product)\n        }\n    }\n\n    Column(\n        modifier = Modifier\n            .fillMaxSize()\n            .padding(16.dp)\n    ) {\n        Text("Alternative Billing Demo", style = MaterialTheme.typography.headlineMedium)\n\n        Spacer(modifier = Modifier.height(16.dp))\n\n        // Platform indicator\n        Text("Platform: ${getPlatformName()}")\n\n        Spacer(modifier = Modifier.height(16.dp))\n\n        // Android: Billing Program selector dropdown (v1.3.0+)\n        if (getPlatformName() == "Android") {\n            Text("Billing Program:", style = MaterialTheme.typography.titleMedium)\n            Spacer(modifier = Modifier.height(8.dp))\n\n            Card(\n                modifier = Modifier\n                    .fillMaxWidth()\n                    .clickable { showProgramSelector = true }\n            ) {\n                Row(\n                    modifier = Modifier.padding(16.dp).fillMaxWidth(),\n                    horizontalArrangement = Arrangement.SpaceBetween\n                ) {\n                    Text(\n                        when (billingProgram) {\n                            BillingProgramAndroid.ExternalOffer -> "External Offer (8.2.0+)"\n                            BillingProgramAndroid.UserChoiceBilling -> "User Choice Billing (7.0+)"\n                            BillingProgramAndroid.ExternalPayments -> "External Payments (8.3.0+, Japan)"\n                            else -> "Select Program"\n                        }\n                    )\n                    Text("\u25bc", color = MaterialTheme.colorScheme.onSurfaceVariant)\n                }\n            }\n\n            // Program Selector Dialog\n            if (showProgramSelector) {\n                AlertDialog(\n                    onDismissRequest = { showProgramSelector = false },\n                    title = { Text("Select Billing Program") },\n                    text = {\n                        Column {\n                            listOf(\n                                Triple(BillingProgramAndroid.ExternalOffer, "External Offer (8.2.0+)", "Only your payment system. Manual 3-step flow."),\n                                Triple(BillingProgramAndroid.UserChoiceBilling, "User Choice Billing (7.0+)", "Users choose Google Play or your system."),\n                                Triple(BillingProgramAndroid.ExternalPayments, "External Payments (8.3.0+, Japan)", "Side-by-side choice. Japan only.")\n                            ).forEach { (program, title, desc) ->\n                                Card(\n                                    modifier = Modifier\n                                        .fillMaxWidth()\n                                        .padding(vertical = 4.dp)\n                                        .clickable {\n                                            billingProgram = program\n                                            showProgramSelector = false\n                                        }\n                                ) {\n                                    Column(modifier = Modifier.padding(12.dp)) {\n                                        Text(title, style = MaterialTheme.typography.titleSmall)\n                                        Text(desc, style = MaterialTheme.typography.bodySmall)\n                                    }\n                                }\n                            }\n                        }\n                    },\n                    confirmButton = {\n                        TextButton(onClick = { showProgramSelector = false }) {\n                            Text("Cancel")\n                        }\n                    }\n                )\n            }\n\n            Spacer(modifier = Modifier.height(16.dp))\n        }\n\n        // External URL input (iOS and Android ExternalPayments)\n        val needsExternalUrl = getPlatformName() == "iOS" ||\n            (getPlatformName() == "Android" && billingProgram == BillingProgramAndroid.ExternalPayments)\n\n        if (needsExternalUrl) {\n            OutlinedTextField(\n                value = externalUrl,\n                onValueChange = { externalUrl = it },\n                label = { Text("External URL") },\n                modifier = Modifier.fillMaxWidth()\n            )\n            Spacer(modifier = Modifier.height(16.dp))\n        }\n\n        // Connection status\n        Text(\n            text = if (connected) "\u2713 Connected" else "Not connected",\n            color = if (connected) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.error\n        )\n\n        Spacer(modifier = Modifier.height(16.dp))\n\n        // Products list\n        Text("Products:", style = MaterialTheme.typography.titleMedium)\n\n        products.forEach { product ->\n            Card(\n                modifier = Modifier\n                    .fillMaxWidth()\n                    .padding(vertical = 8.dp)\n            ) {\n                Column(modifier = Modifier.padding(16.dp)) {\n                    Text(product.title, style = MaterialTheme.typography.titleSmall)\n                    Text(product.description, style = MaterialTheme.typography.bodySmall)\n                    Text(product.displayPrice, style = MaterialTheme.typography.bodyLarge)\n\n                    Spacer(modifier = Modifier.height(8.dp))\n\n                    Button(\n                        onClick = { handlePurchase(product) },\n                        modifier = Modifier.fillMaxWidth()\n                    ) {\n                        Text(\n                            when {\n                                getPlatformName() == "iOS" -> "Buy (External URL)"\n                                billingProgram == BillingProgramAndroid.ExternalOffer -> "Buy (External Offer)"\n                                billingProgram == BillingProgramAndroid.UserChoiceBilling -> "Buy (User Choice)"\n                                billingProgram == BillingProgramAndroid.ExternalPayments -> "Buy (External Payments)"\n                                else -> "Purchase"\n                            }\n                        )\n                    }\n                }\n            }\n        }\n    }\n}\n\n// Platform detection helper\nexpect fun getPlatformName(): String\n'})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Platform-specific implementations:"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'// androidMain/AlternativeBillingScreen.android.kt\nactual fun getPlatformName(): String = "Android"\n'})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'// iosMain/AlternativeBillingScreen.ios.kt\nactual fun getPlatformName(): String = "iOS"\n'})}),"\n",(0,r.jsx)(e.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(e.h3,{id:"initialize-with-billing-program-v130",children:"Initialize with Billing Program (v1.3.0+)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:"import io.github.hyochan.kmpiap.kmpIapInstance\nimport io.github.hyochan.kmpiap.openiap.BillingProgramAndroid\nimport io.github.hyochan.kmpiap.openiap.InitConnectionConfig\n\n// Android with billing program\nval config = InitConnectionConfig(\n    enableBillingProgramAndroid = BillingProgramAndroid.ExternalOffer\n    // Or: BillingProgramAndroid.UserChoiceBilling (7.0+)\n    // Or: BillingProgramAndroid.ExternalPayments (8.3.0+, Japan only)\n    // Or: BillingProgramAndroid.Unspecified (default)\n)\n\nval connected = kmpIapInstance.initConnection(config)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"ios-configuration-infoplist",children:"iOS Configuration (Info.plist)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n    \x3c!-- Countries where external purchases are supported --\x3e\n    <key>SKExternalPurchase</key>\n    <array>\n        <string>kr</string>\n        <string>nl</string>\n        <string>de</string>\n    </array>\n</dict>\n</plist>\n'})}),"\n",(0,r.jsx)(e.h3,{id:"ios-entitlements",children:"iOS Entitlements"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n    <key>com.apple.developer.storekit.external-purchase</key>\n    <true/>\n\n    <key>com.apple.developer.storekit.external-purchase-link</key>\n    <true/>\n</dict>\n</plist>\n'})}),"\n",(0,r.jsx)(e.h2,{id:"event-listeners",children:"Event Listeners"}),"\n",(0,r.jsx)(e.h3,{id:"purchase-updates-google-play",children:"Purchase Updates (Google Play)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'LaunchedEffect(Unit) {\n    kmpIapInstance.purchaseUpdatedListener.collect { purchase ->\n        println("Purchase successful: ${purchase.productId}")\n\n        // Deliver content\n        deliverContent(purchase.productId)\n\n        // Finish transaction\n        kmpIapInstance.finishTransaction(\n            purchase = purchase.toPurchaseInput(),\n            isConsumable = true\n        )\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"user-choice-billing-android",children:"User Choice Billing (Android)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'LaunchedEffect(Unit) {\n    kmpIapInstance.userChoiceBillingListener.collect { details ->\n        println("User selected alternative billing")\n        println("Products: ${details.products}")\n\n        // Process payment with your system\n        processAlternativePayment(details.products)\n\n        // Create and report token\n        val token = kmpIapInstance.createAlternativeBillingTokenAndroid()\n        if (token != null) {\n            reportToGoogleBackend(token)\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"purchase-errors",children:"Purchase Errors"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'LaunchedEffect(Unit) {\n    kmpIapInstance.purchaseErrorListener.collect { error ->\n        when (error.code) {\n            "user_cancelled" -> println("User cancelled")\n            else -> println("Error: ${error.message}")\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsx)(e.h3,{id:"ios",children:"iOS"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Test on iOS 16.0+ devices"}),"\n",(0,r.jsx)(e.li,{children:"Verify external URL opens in Safari"}),"\n",(0,r.jsx)(e.li,{children:"Test deep link return flow"}),"\n",(0,r.jsx)(e.li,{children:"Check entitlements are properly configured"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"android",children:"Android"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Configure billing program in Google Play Console"}),"\n",(0,r.jsx)(e.li,{children:"Test each billing program separately (ExternalOffer, UserChoiceBilling, ExternalPayments)"}),"\n",(0,r.jsx)(e.li,{children:"Verify token generation and reporting"}),"\n",(0,r.jsx)(e.li,{children:"Test dialog behavior for each program type"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Backend Validation"})," - Always validate purchases on your server"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Clear UI"})," - Show users they're leaving the app (iOS)"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Error Handling"})," - Handle all error cases gracefully"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Token Reporting"})," - Report within 24 hours (Android)"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Deep Linking"})," - Essential for iOS return flow"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Mode Selection"})," - Choose appropriate mode for your use case (Android)"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,r.jsx)(e.h3,{id:"check-if-alternative-billing-is-available",children:"Check if Alternative Billing is Available"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'suspend fun isAlternativeBillingSupported(): Boolean {\n    return when (getPlatformName()) {\n        "iOS" -> {\n            // NOTE: This is a placeholder. A real implementation should check the OS version (iOS 16.0+).\n            // You can use Platform.osVersion or similar APIs to check the iOS version.\n            true\n        }\n        "Android" -> {\n            kmpIapInstance.checkAlternativeBillingAvailabilityAndroid()\n        }\n        else -> false\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"handle-alternative-billing-purchase-result",children:"Handle Alternative Billing Purchase Result"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-kotlin",children:'data class AlternativeBillingResult(\n    val success: Boolean,\n    val token: String?,\n    val error: String?\n)\n\nsuspend fun handleAlternativeBillingPurchase(\n    product: ProductCommon\n): AlternativeBillingResult {\n    return when (getPlatformName()) {\n        "iOS" -> {\n            val result = kmpIapInstance.presentExternalPurchaseLinkIOS(\n                url = "https://your-site.com/checkout?product=${product.id}"\n            )\n            AlternativeBillingResult(\n                success = result.success,\n                token = null,\n                error = result.error\n            )\n        }\n        "Android" -> {\n            val isAvailable = kmpIapInstance.checkAlternativeBillingAvailabilityAndroid()\n            if (!isAvailable) {\n                return AlternativeBillingResult(\n                    success = false,\n                    token = null,\n                    error = "Alternative billing not available"\n                )\n            }\n\n            val userAccepted = kmpIapInstance.showAlternativeBillingDialogAndroid()\n            if (!userAccepted) {\n                return AlternativeBillingResult(\n                    success = false,\n                    token = null,\n                    error = "User declined"\n                )\n            }\n\n            // Process payment...\n            val token = kmpIapInstance.createAlternativeBillingTokenAndroid()\n            AlternativeBillingResult(\n                success = token != null,\n                token = token,\n                error = if (token == null) "Failed to create token" else null\n            )\n        }\n        else -> AlternativeBillingResult(\n            success = false,\n            token = null,\n            error = "Platform not supported"\n        )\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(e.h3,{id:"ios-external-url-not-opening",children:"iOS: External URL not opening"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Verify iOS 16.0 or later"}),"\n",(0,r.jsx)(e.li,{children:"Check entitlements are approved"}),"\n",(0,r.jsx)(e.li,{children:"Ensure URLs are configured in Info.plist"}),"\n",(0,r.jsx)(e.li,{children:"Verify URL format (must be valid HTTPS)"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"android-alternative-billing-not-available",children:"Android: Alternative billing not available"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Verify Google Play approval"}),"\n",(0,r.jsx)(e.li,{children:"Check device and Play Store version"}),"\n",(0,r.jsx)(e.li,{children:"Ensure billing mode is configured"}),"\n",(0,r.jsx)(e.li,{children:"Check Google Play Console settings"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"android-token-creation-failed",children:"Android: Token creation failed"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Verify billing mode configuration"}),"\n",(0,r.jsx)(e.li,{children:"Ensure user completed info dialog"}),"\n",(0,r.jsx)(e.li,{children:"Check Google Play Console settings"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"see-also",children:"See Also"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"/kmp-iap/docs/guides/alternative-billing",children:"Alternative Billing Guide"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"/kmp-iap/docs/api/core-methods#ios-specific-alternative-billing",children:"Core Methods - Alternative Billing APIs"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"/kmp-iap/docs/examples/purchase-flow",children:"Purchase Flow Example"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"/kmp-iap/docs/guides/troubleshooting",children:"Error Handling"})}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(p,{...n})}):p(n)}},5159:(n,e,i)=>{i.d(e,{A:()=>a});i(6540);var r=i(6025),l=i(7856),t=i(4848);function a({className:n="iapkit-banner",style:e}){const i=(0,r.A)("/img/iapkit-banner.gif");return(0,t.jsx)("div",{className:n,style:e,children:(0,t.jsx)("a",{href:l.V,target:"_blank",rel:"noopener noreferrer",onClick:async()=>{try{await fetch(l.I,{method:"POST",mode:"no-cors"})}catch(n){console.error("Failed to track banner click:",n)}},style:{display:"block",textAlign:"center",marginBottom:"20px",textDecoration:"none",cursor:"pointer"},children:(0,t.jsx)("img",{src:i,alt:"IAPKit - In-App Purchase Made Simple",style:{height:"auto",borderRadius:"8px",objectFit:"contain"}})})})}},7856:(n,e,i)=>{i.d(e,{I:()=>l,V:()=>r});const r="https://iapkit.com",l="https://www.hyo.dev/api/ad-banner/cmjf0l20n0002249hjrwmgob3"},8453:(n,e,i)=>{i.d(e,{R:()=>a,x:()=>o});var r=i(6540);const l={},t=r.createContext(l);function a(n){const e=r.useContext(t);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:a(n.components),r.createElement(t.Provider,{value:e},n.children)}}}]);